<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lightning Protection Engineers Reporting Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f4f4f4;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .section h2 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }
        
        input[type="text"], input[type="date"], input[type="number"], select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        button {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        .earth-inputs {
            display: none;
            margin-top: 15px;
        }
        
        .earth-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .earth-input-group input {
            width: 120px;
        }
        
        .failure-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .failure-item h4 {
            color: #dc3545;
            margin-bottom: 10px;
        }
        
        .image-upload {
            border: 2px dashed #dee2e6;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .image-upload:hover {
            border-color: #007bff;
        }
        
        .result-display {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .result-display h4 {
            color: #0c5460;
            margin-bottom: 10px;
        }
        
        .standards-dropdown {
            margin-bottom: 20px;
        }
        
        .failures-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background: white;
        }
        
        .failure-option {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .failure-option:hover {
            background-color: #f8f9fa;
        }
        
        .failure-option.selected {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        
        #generateReport {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            margin-top: 30px;
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
        }
        
        .hidden {
            display: none;
        }
        
        .collapsible-container {
            margin-bottom: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .collapsible-header {
            width: 100%;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: none;
            padding: 15px;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            color: #495057;
            transition: background-color 0.3s;
        }
        
        .collapsible-header:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }
        
        .collapsible-content {
            display: none;
            padding: 15px;
            background-color: #fff;
            border-top: 1px solid #dee2e6;
        }
        
        .collapsible-content.active {
            display: block;
        }
        
        .reference-list {
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .reference-list ul {
            padding-left: 20px;
        }
        
        .reference-list li {
            margin-bottom: 5px;
        }

        @media print {
            .container {
                box-shadow: none;
                max-width: none;
                margin: 0;
                padding: 10px;
            }
            
            button {
                display: none;
            }
            
            .reference-section {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>⚡ Lightning Protection Engineers Reporting Tool</h1>
        
        <!-- Collapsible Reference Sections -->
        <div class="section">
            <h2>📚 Standards Reference Guide</h2>
            
            <div class="collapsible-container">
                <button class="collapsible-header" onclick="toggleCollapsible('bs62305')">
                    📋 BS EN 62305 Structure & Requirements
                </button>
                <div id="bs62305" class="collapsible-content">
                    <div class="reference-list">
                        <strong>BS EN 62305-1: General Principles</strong>
                        <ul>
                            <li>Lightning Protection Levels (LPL I-IV)</li>
                            <li>Current division principles</li>
                            <li>Lightning Protection Zones (LPZ 0A, 0B, 1, 2)</li>
                            <li>Protection methods and concepts</li>
                        </ul>
                        <strong>BS EN 62305-2: Risk Management</strong>
                        <ul>
                            <li>Risk assessment procedures</li>
                            <li>R1: Risk of loss of human life</li>
                            <li>R2: Risk of loss of service to public</li>
                            <li>R3: Risk of loss of cultural heritage</li>
                            <li>R4: Risk of economic loss</li>
                        </ul>
                        <strong>BS EN 62305-3: Physical Damage to Structures</strong>
                        <ul>
                            <li>Air termination systems</li>
                            <li>Down conductor systems</li>
                            <li>Earth termination systems (Type A & B)</li>
                            <li>Equipotential bonding</li>
                            <li>Separation distances</li>
                            <li>Material specifications</li>
                        </ul>
                        <strong>BS EN 62305-4: Electrical and Electronic Systems</strong>
                        <ul>
                            <li>Surge Protection Devices (SPDs)</li>
                            <li>Lightning current arresters</li>
                            <li>Overvoltage surge arresters</li>
                            <li>Coordinated SPD protection</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="collapsible-container">
                <button class="collapsible-header" onclick="toggleCollapsible('bs6651')">
                    📋 BS 6651 Structure (Legacy Standard)
                </button>
                <div id="bs6651" class="collapsible-content">
                    <div class="reference-list">
                        <ul>
                            <li>Section 1: Scope and definitions</li>
                            <li>Section 2: Risk factor analysis</li>
                            <li>Section 3: Air termination</li>
                            <li>Section 4: Down conductors</li>
                            <li>Section 5: Earth termination</li>
                            <li>Section 6: Bonding and surge protection</li>
                            <li>Section 7: Materials and construction</li>
                            <li>Section 8: Installation requirements</li>
                            <li>Section 9: Inspection and testing</li>
                            <li>Section 10: Maintenance</li>
                            <li>Annexes A-F: Additional guidance</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="collapsible-container">
                <button class="collapsible-header" onclick="toggleCollapsible('failures')">
                    📋 Common System Failures & Test Requirements
                </button>
                <div id="failures" class="collapsible-content">
                    <div class="reference-list">
                        <strong>Typical Failures:</strong>
                        <ul>
                            <li>Earth resistance above acceptable limits (>10Ω typically)</li>
                            <li>Poor continuity between components</li>
                            <li>Corrosion of conductors/connections</li>
                            <li>Missing or damaged air terminals</li>
                            <li>Inadequate equipotential bonding</li>
                            <li>Non-compliant materials used</li>
                            <li>Insufficient separation distances</li>
                            <li>SPD failures or missing devices</li>
                        </ul>
                        <strong>Test Requirements:</strong>
                        <ul>
                            <li>Visual inspection (annual minimum)</li>
                            <li>Earth resistance testing</li>
                            <li>Continuity testing</li>
                            <li>SPD functional testing</li>
                            <li>Documentation verification</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Basic Information Section -->
        <div class="section">
            <h2>📝 Site Information</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="siteAddress">Site Address:</label>
                    <textarea id="siteAddress" rows="3" placeholder="Enter full site address..."></textarea>
                </div>
                <div class="form-group">
                    <label for="testDate">Date:</label>
                    <input type="date" id="testDate">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="engineerName">Engineer Name:</label>
                    <input type="text" id="engineerName" placeholder="Enter engineer name...">
                </div>
                <div class="form-group">
                    <label for="testKitRef">Test Kit Reference:</label>
                    <input type="text" id="testKitRef" placeholder="Enter test kit reference...">
                </div>
            </div>
            <div class="form-group">
                <label for="buildingImage">Building Image (Cover Page):</label>
                <div class="image-upload" onclick="document.getElementById('buildingImageFile').click()">
                    <input type="file" id="buildingImageFile" accept="image/*" style="display: none;" onchange="handleImageUpload(this, 'buildingImagePreview')">
                    <div id="buildingImagePreview">Click to upload building image</div>
                </div>
            </div>
        </div>

        <!-- Standards Selection -->
        <div class="section">
            <h2>📖 Standard Selection & Failures</h2>
            <div class="form-group standards-dropdown">
                <label for="standard">Select Standard:</label>
                <select id="standard" onchange="updateFailuresList()">
                    <option value="">Select a standard...</option>
                    <option value="BS EN 62305">BS EN 62305 (Current Standard)</option>
                    <option value="BS 6651">BS 6651 (Legacy Standard)</option>
                    <option value="CP 326">CP 326 (Historical Standard)</option>
                    <option value="NF C 17-102">NF C 17-102:2011 (ESE Systems)</option>
                </select>
            </div>
            <div id="failuresContainer" class="hidden">
                <label>Available Failures for Selected Standard:</label>
                <div id="failuresList" class="failures-list"></div>
            </div>
        </div>

        <!-- Selected Failures -->
        <div class="section">
            <h2>⚠️ Selected Failures & Comments</h2>
            <div id="selectedFailures"></div>
        </div>

        <!-- Surge Protection -->
        <div class="section">
            <h2>🛡️ Surge Protection Details</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="surgeInstalled">Surge Protection Installed:</label>
                    <select id="surgeInstalled">
                        <option value="No">No</option>
                        <option value="Yes">Yes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="surgeType">Type:</label>
                    <input type="text" id="surgeType" placeholder="e.g., Type 1, Type 2, Combined...">
                </div>
            </div>
            <div class="form-group">
                <label for="surgeSafe">Is it Safe:</label>
                <select id="surgeSafe">
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                    <option value="Requires Further Investigation">Requires Further Investigation</option>
                </select>
            </div>
        </div>

        <!-- Earth Resistance Testing -->
        <div class="section">
            <h2>🌍 Earth Resistance Testing</h2>
            <div class="form-group">
                <label for="numEarths">Number of Earths Tested:</label>
                <input type="number" id="numEarths" min="0" max="20" onchange="generateEarthInputs()">
            </div>
            <div id="earthInputs" class="earth-inputs"></div>
            <div id="earthResult" class="result-display hidden">
                <h4>Overall Earth Resistance:</h4>
                <div id="overallResistance"></div>
            </div>
            <div class="form-group">
                <label for="earthImages">Earth Test Images:</label>
                <div class="image-upload" onclick="document.getElementById('earthImagesFile').click()">
                    <input type="file" id="earthImagesFile" accept="image/*" multiple style="display: none;" onchange="handleMultipleImageUpload(this, 'earthImagesPreview')">
                    <div id="earthImagesPreview">Click to upload earth test images</div>
                </div>
            </div>
        </div>

        <!-- General Comments Section -->
        <div class="section">
            <h2>💬 General Comments</h2>
            <div class="form-group">
                <label for="generalComments">Additional Comments:</label>
                <textarea id="generalComments" rows="4" placeholder="Enter any additional observations, recommendations, or general comments about the lightning protection system..."></textarea>
            </div>
        </div>

        <!-- Logo Upload Section -->
        <div class="section">
            <h2>🏢 Company Branding</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="coverLogo">Cover Page Logo (Large):</label>
                    <div class="image-upload" onclick="document.getElementById('coverLogoFile').click()">
                        <input type="file" id="coverLogoFile" accept="image/*" style="display: none;" onchange="handleImageUpload(this, 'coverLogoPreview')">
                        <div id="coverLogoPreview">Click to upload cover page logo</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="headerLogo">Header Logo (Small):</label>
                    <div class="image-upload" onclick="document.getElementById('headerLogoFile').click()">
                        <input type="file" id="headerLogoFile" accept="image/*" style="display: none;" onchange="handleImageUpload(this, 'headerLogoPreview')">
                        <div id="headerLogoPreview">Click to upload header logo</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Final Comments Section -->
        <div class="section">
            <h2>📝 Final Summary Comments</h2>
            <div class="form-group">
                <label for="finalComments">Summary & Recommendations:</label>
                <textarea id="finalComments" rows="4" placeholder="Enter final summary, conclusions, and recommendations for the lightning protection system..."></textarea>
            </div>
        </div>

        <!-- Generate Report Button -->
        <button id="generateReport" onclick="generatePDF()">🎯 Generate Professional PDF Report</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Comprehensive failure definitions by standard
        const standardFailures = {
            "BS EN 62305": [
                "Earth resistance exceeds 10Ω requirement",
                "Poor continuity between air terminals and down conductors",
                "Air terminals not meeting LPL requirements",
                "Down conductors not following shortest route to earth",
                "Inadequate separation distance from metalwork",
                "Missing equipotential bonding connections",
                "Non-compliant conductor materials or dimensions",
                "Earth termination system Type A/B non-compliance",
                "Missing or inadequate surge protection devices",
                "SPD coordination issues between protection levels",
                "Insufficient lightning protection zones implementation",
                "Risk assessment not conducted or outdated",
                "Missing bonds to external metalwork",
                "Corrosion exceeding acceptable limits",
                "Mechanical damage to system components",
                "Installation not meeting Class I/II/III/IV requirements",
                "Missing test clamps or inspection facilities",
                "Documentation incomplete or missing",
                "Non-compliance with manufacturer specifications",
                "Environmental protection inadequate"
            ],
            "BS 6651": [
                "Earth electrode resistance above 10Ω",
                "Continuity failure in conductor network",
                "Air terminal spacing exceeds 20m/25m limits",
                "Down conductor route not direct to earth",
                "Missing side-flash protection bonds",
                "Conductor cross-sectional area insufficient",
                "Earth electrode depth/installation inadequate",
                "Joint resistance exceeding 0.05Ω",
                "Missing surge diverter protection",
                "Corrosion affecting system integrity",
                "Mechanical protection inadequate",
                "Test facilities not provided",
                "Risk factor calculation not meeting 10⁻⁵ limit",
                "Material specifications non-compliant",
                "Missing bonds to metallic services",
                "Down conductor count insufficient for building size",
                "Air terminal height inadequate for protection",
                "Missing isolation joints where required",
                "Installation records incomplete",
                "Maintenance schedule not followed"
            ],
            "CP 326": [
                "Non-compliance with basic protection principles",
                "Inadequate conductor sizing for historic requirements",
                "Missing earth connections",
                "Poor workmanship in installations",
                "Material degradation beyond acceptable limits",
                "Insufficient protection coverage",
                "Missing documentation from original installation",
                "Non-standard component usage",
                "Inadequate maintenance records",
                "System modifications without proper design review"
            ],
            "NF C 17-102": [
                "ESE efficiency (ΔT) not verified or inadequate",
                "Protection radius calculation errors",
                "Air terminal not meeting ESE testing requirements",
                "Down conductor installation non-compliant",
                "Earth resistance exceeding French standard limits",
                "ESE device not certified to NF C 17-102",
                "Missing surge protection coordination",
                "Equipotential bonding inadequate",
                "Installation height calculations incorrect",
                "Early streamer emission timing not verified",
                "Protection level selection inappropriate",
                "Missing risk assessment per French requirements",
                "EMC compliance issues with electronic ESE devices",
                "Mechanical strength testing not verified",
                "Current withstand capability not proven",
                "Protection zone overlap insufficient",
                "Installation not meeting manufacturer requirements",
                "Missing periodic testing verification",
                "Documentation not in French standard format",
                "System commissioning incomplete"
            ]
        };

        let selectedFailuresList = [];
        let earthResistances = [];
        let uploadedImages = {};

        // Set today's date as default
        document.getElementById('testDate').valueAsDate = new Date();

        function toggleCollapsible(id) {
            const content = document.getElementById(id);
            content.classList.toggle('active');
        }

        function updateFailuresList() {
            const standard = document.getElementById('standard').value;
            const container = document.getElementById('failuresContainer');
            const failuresList = document.getElementById('failuresList');
            
            if (standard && standardFailures[standard]) {
                container.classList.remove('hidden');
                failuresList.innerHTML = '';
                
                standardFailures[standard].forEach((failure, index) => {
                    const failureDiv = document.createElement('div');
                    failureDiv.className = 'failure-option';
                    failureDiv.textContent = failure;
                    failureDiv.onclick = () => selectFailure(failure, failureDiv);
                    failuresList.appendChild(failureDiv);
                });
            } else {
                container.classList.add('hidden');
            }
        }

        function selectFailure(failure, element) {
            if (element.classList.contains('selected')) {
                element.classList.remove('selected');
                selectedFailuresList = selectedFailuresList.filter(f => f.failure !== failure);
            } else {
                element.classList.add('selected');
                selectedFailuresList.push({
                    failure: failure,
                    comment: '',
                    image: null
                });
            }
            updateSelectedFailures();
        }

        function updateSelectedFailures() {
            const container = document.getElementById('selectedFailures');
            container.innerHTML = '';
            
            selectedFailuresList.forEach((item, index) => {
                const failureDiv = document.createElement('div');
                failureDiv.className = 'failure-item';
                failureDiv.innerHTML = `
                    <h4>${item.failure}</h4>
                    <div class="form-group">
                        <label>Comment:</label>
                        <textarea onchange="updateFailureComment(${index}, this.value)" placeholder="Add detailed comments about this failure...">${item.comment}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Image:</label>
                        <div class="image-upload" onclick="document.getElementById('failureImage${index}').click()">
                            <input type="file" id="failureImage${index}" accept="image/*" style="display: none;" onchange="handleFailureImage(${index}, this)">
                            <div id="failureImagePreview${index}">${item.image ? 'Image uploaded' : 'Click to upload image'}</div>
                        </div>
                    </div>
                `;
                container.appendChild(failureDiv);
            });
        }

        function updateFailureComment(index, comment) {
            selectedFailuresList[index].comment = comment;
        }

        function handleFailureImage(index, input) {
            if (input.files[0]) {
                const file = input.files[0];
                selectedFailuresList[index].image = file;
                
                // Read the image data
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedFailuresList[index].imageData = e.target.result;
                };
                reader.readAsDataURL(file);
                
                document.getElementById(`failureImagePreview${index}`).textContent = 'Image uploaded';
            }
        }

        function generateEarthInputs() {
            const numEarths = parseInt(document.getElementById('numEarths').value) || 0;
            const container = document.getElementById('earthInputs');
            
            if (numEarths > 0) {
                container.style.display = 'block';
                container.innerHTML = '<h4>Enter Earth Resistance Values (Ω):</h4>';
                
                for (let i = 1; i <= numEarths; i++) {
                    const inputGroup = document.createElement('div');
                    inputGroup.className = 'earth-input-group';
                    inputGroup.innerHTML = `
                        <label>Earth ${i}:</label>
                        <input type="number" step="0.01" min="0" onchange="updateEarthResistance(${i-1}, this.value)" placeholder="0.00">
                        <span>Ω</span>
                    `;
                    container.appendChild(inputGroup);
                }
                earthResistances = new Array(numEarths).fill(0);
            } else {
                container.style.display = 'none';
                document.getElementById('earthResult').classList.add('hidden');
            }
        }

        function updateEarthResistance(index, value) {
            earthResistances[index] = parseFloat(value) || 0;
            calculateOverallResistance();
        }

        function calculateOverallResistance() {
            if (earthResistances.length > 0 && earthResistances.some(r => r > 0)) {
                // Parallel resistance formula: 1/RT = 1/R1 + 1/R2 + ... + 1/Rn
                const validResistances = earthResistances.filter(r => r > 0);
                const reciprocalSum = validResistances.reduce((sum, r) => sum + (1/r), 0);
                const overallResistance = 1 / reciprocalSum;
                
                document.getElementById('earthResult').classList.remove('hidden');
                document.getElementById('overallResistance').innerHTML = `
                    <strong>${overallResistance.toFixed(3)} Ω</strong>
                    <br><small>Calculated from ${validResistances.length} earth electrode(s)</small>
                `;
            } else {
                document.getElementById('earthResult').classList.add('hidden');
            }
        }

        function handleImageUpload(input, previewId) {
            if (input.files[0]) {
                const file = input.files[0];
                uploadedImages[previewId] = file;
                
                // Create a FileReader to read the image
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedImages[previewId + '_data'] = e.target.result;
                };
                reader.readAsDataURL(file);
                
                document.getElementById(previewId).textContent = 'Image uploaded successfully';
            }
        }

        function handleMultipleImageUpload(input, previewId) {
            if (input.files.length > 0) {
                const files = Array.from(input.files);
                uploadedImages[previewId] = files;
                uploadedImages[previewId + '_data'] = [];
                
                // Read all files
                files.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        uploadedImages[previewId + '_data'][index] = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
                
                document.getElementById(previewId).textContent = `${input.files.length} image(s) uploaded`;
            }
        }

        function addImageToPDF(pdf, imageData, x, y, maxWidth, maxHeight) {
            if (imageData) {
                try {
                    // Determine image format
                    const format = imageData.includes('data:image/jpeg') ? 'JPEG' : 'PNG';
                    
                    // Add image to PDF with size constraints
                    pdf.addImage(imageData, format, x, y, maxWidth, maxHeight);
                    return maxHeight + 10; // Return height used plus margin
                } catch (error) {
                    console.error('Error adding image to PDF:', error);
                    return 0;
                }
            }
            return 0;
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            // Company footer
            const footer = "Strike Point Lightning Protection Ltd Registered office: Atkinson Evans, 10 Arnot Hill Road, Nottingham NG5 6LJ. Company No. 15114852, Registered in England and Wales. @: info@strikepoint.uk Tel: 01159903220";
            
            // Get form data
            const siteAddress = document.getElementById('siteAddress').value;
            const testDate = document.getElementById('testDate').value;
            const engineerName = document.getElementById('engineerName').value;
            const testKitRef = document.getElementById('testKitRef').value;
            const standard = document.getElementById('standard').value;
            const surgeInstalled = document.getElementById('surgeInstalled').value;
            const surgeType = document.getElementById('surgeType').value;
            const surgeSafe = document.getElementById('surgeSafe').value;
            const generalComments = document.getElementById('generalComments').value;
            const finalComments = document.getElementById('finalComments').value;
            
            let yPosition = 20;
            
            // Page 1 - Cover Page
            // Add cover logo if uploaded
            if (uploadedImages['coverLogoPreview_data']) {
                const logoHeight = addImageToPDF(pdf, uploadedImages['coverLogoPreview_data'], 60, 20, 90, 40);
                yPosition = 70;
            } else {
                yPosition = 30;
            }
            
            pdf.setFontSize(24);
            pdf.setFont(undefined, 'bold');
            pdf.text('Lightning Protection System Report', 105, yPosition, { align: 'center' });
            yPosition += 30;
            
            // Building image (if uploaded)
            if (uploadedImages['buildingImagePreview_data']) {
                const imageHeight = addImageToPDF(pdf, uploadedImages['buildingImagePreview_data'], 30, yPosition, 150, 100);
                yPosition += imageHeight + 20;
            }
            
            // Site details
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('Site Details:', 105, yPosition, { align: 'center' });
            yPosition += 20;
            
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'normal');
            const details = [
                `Site Address: ${siteAddress}`,
                `Date: ${testDate}`,
                `Engineer: ${engineerName}`,
                `Test Kit Reference: ${testKitRef}`
            ];
            
            details.forEach((detail, index) => {
                pdf.text(detail, 105, yPosition + (index * 10), { align: 'center' });
            });
            
            // Page 2 - Report
            pdf.addPage();
            yPosition = 20;
            
            // Add header logo if uploaded
            if (uploadedImages['headerLogoPreview_data']) {
                addImageToPDF(pdf, uploadedImages['headerLogoPreview_data'], 170, 10, 30, 15);
            }
            
            // Summary
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text('INSPECTION SUMMARY', 20, yPosition);
            yPosition += 15;
            
            // Pass/Fail determination
            const hasFaults = selectedFailuresList.length > 0;
            pdf.setFontSize(14);
            if (hasFaults) {
                pdf.setTextColor(220, 20, 60); // Red
                pdf.text('RESULT: FAIL', 20, yPosition);
            } else {
                pdf.setTextColor(34, 139, 34); // Green
                pdf.text('RESULT: PASS', 20, yPosition);
            }
            pdf.setTextColor(0, 0, 0); // Reset to black
            yPosition += 20;
            
            // Standard used
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text(`Standard Applied: ${standard}`, 20, yPosition);
            yPosition += 15;
            
            // Findings
            if (selectedFailuresList.length > 0) {
                pdf.setFont(undefined, 'bold');
                pdf.text('FINDINGS:', 20, yPosition);
                yPosition += 10;
                
                selectedFailuresList.forEach((failure, index) => {
                    pdf.setFont(undefined, 'bold');
                    pdf.text(`${index + 1}. ${failure.failure}`, 20, yPosition);
                    yPosition += 8;
                    
                    if (failure.comment) {
                        pdf.setFont(undefined, 'normal');
                        const commentLines = pdf.splitTextToSize(`Comment: ${failure.comment}`, 170);
                        pdf.text(commentLines, 25, yPosition);
                        yPosition += commentLines.length * 5;
                    }
                    
                    if (failure.imageData) {
                        pdf.setFont(undefined, 'italic');
                        pdf.text('Image:', 25, yPosition);
                        yPosition += 8;
                        const imageHeight = addImageToPDF(pdf, failure.imageData, 25, yPosition, 80, 60);
                        yPosition += imageHeight;
                    }
                    
                    yPosition += 5;
                    
                    // Add new page if needed
                    if (yPosition > 250) {
                        pdf.addPage();
                        yPosition = 20;
                        // Add footer to previous page
                        pdf.setPage(pdf.internal.getNumberOfPages() - 1);
                        pdf.setFontSize(8);
                        const footerLines = pdf.splitTextToSize(footer, 190);
                        pdf.text(footerLines, 105, 280, { align: 'center' });
                        pdf.setPage(pdf.internal.getNumberOfPages());
                        
                        // Add header logo to new page
                        if (uploadedImages['headerLogoPreview_data']) {
                            addImageToPDF(pdf, uploadedImages['headerLogoPreview_data'], 170, 10, 30, 15);
                        }
                    }
                });
            } else {
                pdf.setFont(undefined, 'normal');
                pdf.text('No faults identified during inspection.', 20, yPosition);
                yPosition += 10;
            }
            
            // Surge Protection Details
            yPosition += 10;
            pdf.setFont(undefined, 'bold');
            pdf.text('SURGE PROTECTION:', 20, yPosition);
            yPosition += 10;
            
            pdf.setFont(undefined, 'normal');
            pdf.text(`Installed: ${surgeInstalled}`, 20, yPosition);
            yPosition += 8;
            if (surgeInstalled === 'Yes') {
                pdf.text(`Type: ${surgeType}`, 20, yPosition);
                yPosition += 8;
                pdf.text(`Status: ${surgeSafe}`, 20, yPosition);
                yPosition += 8;
            }
            
            // General Comments
            if (generalComments) {
                yPosition += 10;
                pdf.setFont(undefined, 'bold');
                pdf.text('GENERAL COMMENTS:', 20, yPosition);
                yPosition += 10;
                
                pdf.setFont(undefined, 'normal');
                const commentLines = pdf.splitTextToSize(generalComments, 170);
                pdf.text(commentLines, 20, yPosition);
                yPosition += commentLines.length * 5 + 10;
            }
            
            // Page 3 - Earth Resistance Testing
            pdf.addPage();
            yPosition = 20;
            
            // Add header logo
            if (uploadedImages['headerLogoPreview_data']) {
                addImageToPDF(pdf, uploadedImages['headerLogoPreview_data'], 170, 10, 30, 15);
            }
            
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text('EARTH RESISTANCE TESTING', 20, yPosition);
            yPosition += 15;
            
            const numEarths = parseInt(document.getElementById('numEarths').value) || 0;
            if (numEarths > 0) {
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text('Individual Earth Readings:', 20, yPosition);
                yPosition += 10;
                
                pdf.setFont(undefined, 'normal');
                earthResistances.forEach((resistance, index) => {
                    pdf.text(`Earth ${index + 1}: ${resistance.toFixed(2)} Ω`, 20, yPosition);
                    yPosition += 8;
                });
                
                // Overall resistance
                if (earthResistances.some(r => r > 0)) {
                    const validResistances = earthResistances.filter(r => r > 0);
                    const reciprocalSum = validResistances.reduce((sum, r) => sum + (1/r), 0);
                    const overallResistance = 1 / reciprocalSum;
                    
                    yPosition += 10;
                    pdf.setFont(undefined, 'bold');
                    pdf.text(`Overall System Resistance: ${overallResistance.toFixed(3)} Ω`, 20, yPosition);
                    yPosition += 10;
                    
                    // Compliance check
                    pdf.setFont(undefined, 'normal');
                    if (overallResistance <= 10) {
                        pdf.setTextColor(34, 139, 34); // Green
                        pdf.text('✓ Complies with 10Ω requirement', 20, yPosition);
                    } else {
                        pdf.setTextColor(220, 20, 60); // Red
                        pdf.text('✗ Exceeds 10Ω requirement - FAIL', 20, yPosition);
                    }
                    pdf.setTextColor(0, 0, 0); // Reset to black
                    yPosition += 15;
                }
                
                // Earth test images
                if (uploadedImages['earthImagesPreview_data']) {
                    pdf.setFont(undefined, 'bold');
                    pdf.text('Earth Test Images:', 20, yPosition);
                    yPosition += 10;
                    
                    const images = Array.isArray(uploadedImages['earthImagesPreview_data']) ? 
                        uploadedImages['earthImagesPreview_data'] : [uploadedImages['earthImagesPreview_data']];
                    
                    images.forEach((imageData, index) => {
                        if (imageData && yPosition < 230) {
                            const imageHeight = addImageToPDF(pdf, imageData, 20, yPosition, 80, 60);
                            yPosition += imageHeight + 5;
                            
                            // Add new page if needed
                            if (yPosition > 230 && index < images.length - 1) {
                                pdf.addPage();
                                yPosition = 20;
                                if (uploadedImages['headerLogoPreview_data']) {
                                    addImageToPDF(pdf, uploadedImages['headerLogoPreview_data'], 170, 10, 30, 15);
                                }
                            }
                        }
                    });
                }
            } else {
                pdf.setFont(undefined, 'normal');
                pdf.text('No earth resistance testing performed.', 20, yPosition);
                yPosition += 15;
            }
            
            // Final Comments
            if (finalComments) {
                yPosition += 10;
                pdf.setFont(undefined, 'bold');
                pdf.text('FINAL SUMMARY & RECOMMENDATIONS:', 20, yPosition);
                yPosition += 10;
                
                pdf.setFont(undefined, 'normal');
                const finalLines = pdf.splitTextToSize(finalComments, 170);
                pdf.text(finalLines, 20, yPosition);
            }
            
            // Add footer to all pages except cover page
            const totalPages = pdf.internal.getNumberOfPages();
            for (let i = 2; i <= totalPages; i++) {
                pdf.setPage(i);
                pdf.setFontSize(8);
                const footerLines = pdf.splitTextToSize(footer, 190);
                pdf.text(footerLines, 105, 280, { align: 'center' });
                
                // Add header logo to each page if not already added
                if (uploadedImages['headerLogoPreview_data']) {
                    addImageToPDF(pdf, uploadedImages['headerLogoPreview_data'], 170, 10, 30, 15);
                }
            }
            
            // Generate filename
            const date = new Date().toISOString().split('T')[0];
            const filename = `Lightning_Protection_Report_${date}.pdf`;
            
            // Save the PDF
            pdf.save(filename);
        }
    </script></script>
    <script>
        // Comprehensive failure definitions by standard
        const standardFailures = {
            "BS EN 62305": [
                "Earth resistance exceeds 10Ω requirement",
                "Poor continuity between air terminals and down conductors",
                "Air terminals not meeting LPL requirements",
                "Down conductors not following shortest route to earth",
                "Inadequate separation distance from metalwork",
                "Missing equipotential bonding connections",
                "Non-compliant conductor materials or dimensions",
                "Earth termination system Type A/B non-compliance",
                "Missing or inadequate surge protection devices",
                "SPD coordination issues between protection levels",
                "Insufficient lightning protection zones implementation",
                "Risk assessment not conducted or outdated",
                "Missing bonds to external metalwork",
                "Corrosion exceeding acceptable limits",
                "Mechanical damage to system components",
                "Installation not meeting Class I/II/III/IV requirements",
                "Missing test clamps or inspection facilities",
                "Documentation incomplete or missing",
                "Non-compliance with manufacturer specifications",
                "Environmental protection inadequate"
            ],
            "BS 6651": [
                "Earth electrode resistance above 10Ω",
                "Continuity failure in conductor network",
                "Air terminal spacing exceeds 20m/25m limits",
                "Down conductor route not direct to earth",
                "Missing side-flash protection bonds",
                "Conductor cross-sectional area insufficient",
                "Earth electrode depth/installation inadequate",
                "Joint resistance exceeding 0.05Ω",
                "Missing surge diverter protection",
                "Corrosion affecting system integrity",
                "Mechanical protection inadequate",
                "Test facilities not provided",
                "Risk factor calculation not meeting 10⁻⁵ limit",
                "Material specifications non-compliant",
                "Missing bonds to metallic services",
                "Down conductor count insufficient for building size",
                "Air terminal height inadequate for protection",
                "Missing isolation joints where required",
                "Installation records incomplete",
                "Maintenance schedule not followed"
            ],
            "CP 326": [
                "Non-compliance with basic protection principles",
                "Inadequate conductor sizing for historic requirements",
                "Missing earth connections",
                "Poor workmanship in installations",
                "Material degradation beyond acceptable limits",
                "Insufficient protection coverage",
                "Missing documentation from original installation",
                "Non-standard component usage",
                "Inadequate maintenance records",
                "System modifications without proper design review"
            ],
            "NF C 17-102": [
                "ESE efficiency (ΔT) not verified or inadequate",
                "Protection radius calculation errors",
                "Air terminal not meeting ESE testing requirements",
                "Down conductor installation non-compliant",
                "Earth resistance exceeding French standard limits",
                "ESE device not certified to NF C 17-102",
                "Missing surge protection coordination",
                "Equipotential bonding inadequate",
                "Installation height calculations incorrect",
                "Early streamer emission timing not verified",
                "Protection level selection inappropriate",
                "Missing risk assessment per French requirements",
                "EMC compliance issues with electronic ESE devices",
                "Mechanical strength testing not verified",
                "Current withstand capability not proven",
                "Protection zone overlap insufficient",
                "Installation not meeting manufacturer requirements",
                "Missing periodic testing verification",
                "Documentation not in French standard format",
                "System commissioning incomplete"
            ]
        };

        let selectedFailuresList = [];
        let earthResistances = [];
        let uploadedImages = {};

        // Set today's date as default
        document.getElementById('testDate').valueAsDate = new Date();

        function toggleCollapsible(id) {
            const content = document.getElementById(id);
            content.classList.toggle('active');
        }

        function updateFailuresList() {
            const standard = document.getElementById('standard').value;
            const container = document.getElementById('failuresContainer');
            const failuresList = document.getElementById('failuresList');
            
            if (standard && standardFailures[standard]) {
                container.classList.remove('hidden');
                failuresList.innerHTML = '';
                
                standardFailures[standard].forEach((failure, index) => {
                    const failureDiv = document.createElement('div');
                    failureDiv.className = 'failure-option';
                    failureDiv.textContent = failure;
                    failureDiv.onclick = () => selectFailure(failure, failureDiv);
                    failuresList.appendChild(failureDiv);
                });
            } else {
                container.classList.add('hidden');
            }
        }

        function selectFailure(failure, element) {
            if (element.classList.contains('selected')) {
                element.classList.remove('selected');
                selectedFailuresList = selectedFailuresList.filter(f => f.failure !== failure);
            } else {
                element.classList.add('selected');
                selectedFailuresList.push({
                    failure: failure,
                    comment: '',
                    image: null
                });
            }
            updateSelectedFailures();
        }

        function updateSelectedFailures() {
            const container = document.getElementById('selectedFailures');
            container.innerHTML = '';
            
            selectedFailuresList.forEach((item, index) => {
                const failureDiv = document.createElement('div');
                failureDiv.className = 'failure-item';
                failureDiv.innerHTML = `
                    <h4>${item.failure}</h4>
                    <div class="form-group">
                        <label>Comment:</label>
                        <textarea onchange="updateFailureComment(${index}, this.value)" placeholder="Add detailed comments about this failure...">${item.comment}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Image:</label>
                        <div class="image-upload" onclick="document.getElementById('failureImage${index}').click()">
                            <input type="file" id="failureImage${index}" accept="image/*" style="display: none;" onchange="handleFailureImage(${index}, this)">
                            <div id="failureImagePreview${index}">${item.image ? 'Image uploaded' : 'Click to upload image'}</div>
                        </div>
                    </div>
                `;
                container.appendChild(failureDiv);
            });
        }

        function updateFailureComment(index, comment) {
            selectedFailuresList[index].comment = comment;
        }

        function handleFailureImage(index, input) {
            if (input.files[0]) {
                selectedFailuresList[index].image = input.files[0];
                document.getElementById(`failureImagePreview${index}`).textContent = 'Image uploaded';
            }
        }

        function generateEarthInputs() {
            const numEarths = parseInt(document.getElementById('numEarths').value) || 0;
            const container = document.getElementById('earthInputs');
            
            if (numEarths > 0) {
                container.style.display = 'block';
                container.innerHTML = '<h4>Enter Earth Resistance Values (Ω):</h4>';
                
                for (let i = 1; i <= numEarths; i++) {
                    const inputGroup = document.createElement('div');
                    inputGroup.className = 'earth-input-group';
                    inputGroup.innerHTML = `
                        <label>Earth ${i}:</label>
                        <input type="number" step="0.01" min="0" onchange="updateEarthResistance(${i-1}, this.value)" placeholder="0.00">
                        <span>Ω</span>
                    `;
                    container.appendChild(inputGroup);
                }
                earthResistances = new Array(numEarths).fill(0);
            } else {
                container.style.display = 'none';
                document.getElementById('earthResult').classList.add('hidden');
            }
        }

        function updateEarthResistance(index, value) {
            earthResistances[index] = parseFloat(value) || 0;
            calculateOverallResistance();
        }

        function calculateOverallResistance() {
            if (earthResistances.length > 0 && earthResistances.some(r => r > 0)) {
                // Parallel resistance formula: 1/RT = 1/R1 + 1/R2 + ... + 1/Rn
                const validResistances = earthResistances.filter(r => r > 0);
                const reciprocalSum = validResistances.reduce((sum, r) => sum + (1/r), 0);
                const overallResistance = 1 / reciprocalSum;
                
                document.getElementById('earthResult').classList.remove('hidden');
                document.getElementById('overallResistance').innerHTML = `
                    <strong>${overallResistance.toFixed(3)} Ω</strong>
                    <br><small>Calculated from ${validResistances.length} earth electrode(s)</small>
                `;
            } else {
                document.getElementById('earthResult').classList.add('hidden');
            }
        }

        function handleImageUpload(input, previewId) {
            if (input.files[0]) {
                const file = input.files[0];
                uploadedImages[previewId] = file;
                
                // Create a FileReader to read the image
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedImages[previewId + '_data'] = e.target.result;
                };
                reader.readAsDataURL(file);
                
                document.getElementById(previewId).textContent = 'Image uploaded successfully';
            }
        }

        function handleMultipleImageUpload(input, previewId) {
            if (input.files.length > 0) {
                const files = Array.from(input.files);
                uploadedImages[previewId] = files;
                uploadedImages[previewId + '_data'] = [];
                
                // Read all files
                files.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        uploadedImages[previewId + '_data'][index] = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
                
                document.getElementById(previewId).textContent = `${input.files.length} image(s) uploaded`;
            }
        }

        function handleFailureImage(index, input) {
            if (input.files[0]) {
                const file = input.files[0];
                selectedFailuresList[index].image = file;
                
                // Read the image data
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedFailuresList[index].imageData = e.target.result;
                };
                reader.readAsDataURL(file);
                
                document.getElementById(`failureImagePreview${index}`).textContent = 'Image uploaded';
            }
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            // Company footer
            const footer = "Strike Point Lightning Protection Ltd Registered office: Atkinson Evans, 10 Arnot Hill Road, Nottingham NG5 6LJ. Company No. 15114852, Registered in England and Wales. @: info@strikepoint.uk Tel: 01159903220";
            
            // Get form data
            const siteAddress = document.getElementById('siteAddress').value;
            const testDate = document.getElementById('testDate').value;
            const engineerName = document.getElementById('engineerName').value;
            const testKitRef = document.getElementById('testKitRef').value;
            const standard = document.getElementById('standard').value;
            const surgeInstalled = document.getElementById('surgeInstalled').value;
            const surgeType = document.getElementById('surgeType').value;
            const surgeSafe = document.getElementById('surgeSafe').value;
            const generalComments = document.getElementById('generalComments').value;
            const finalComments = document.getElementById('finalComments').value;
            
            let yPosition = 20;
            
            // Page 1 - Cover Page
            // Add cover logo if uploaded
            if (uploadedImages['coverLogoPreview_data']) {
                const logoHeight = addImageToPDF(pdf, uploadedImages['coverLogoPreview_data'], 60, 20, 90, 40);
                yPosition = 70;
            } else {
                yPosition = 30;
            }
            
            pdf.setFontSize(24);
            pdf.setFont(undefined, 'bold');
            pdf.text('Lightning Protection System Report', 105, yPosition, { align: 'center' });
            yPosition += 30;
            
            // Building image (if uploaded)
            if (uploadedImages['buildingImagePreview_data']) {
                const imageHeight = addImageToPDF(pdf, uploadedImages['buildingImagePreview_data'], 30, yPosition, 150, 100);
                yPosition += imageHeight + 20;
            }
            
            // Site details
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('Site Details:', 105, yPosition, { align: 'center' });
            yPosition += 20;
            
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'normal');
            const details = [
                `Site Address: ${siteAddress}`,
                `Date: ${testDate}`,
                `Engineer: ${engineerName}`,
                `Test Kit Reference: ${testKitRef}`
            ];
            
            details.forEach((detail, index) => {
                pdf.text(detail, 105, yPosition + (index * 10), { align: 'center' });
            });
            
            // Page 2 - Report
            pdf.addPage();
            yPosition = 20;
            
            // Add header logo if uploaded
            if (uploadedImages['headerLogoPreview_data']) {
                addImageToPDF(pdf, uploadedImages['headerLogoPreview_data'], 170, 10, 30, 15);
            }
            
            // Summary
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text('INSPECTION SUMMARY', 20, yPosition);
            yPosition += 15;
            
            // Pass/Fail determination
            const hasFaults = selectedFailuresList.length > 0;
            pdf.setFontSize(14);
            if (hasFaults) {
                pdf.setTextColor(220, 20, 60); // Red
                pdf.text('RESULT: FAIL', 20, yPosition);
            } else {
                pdf.setTextColor(34, 139, 34); // Green
                pdf.text('RESULT: PASS', 20, yPosition);
            }
            pdf.setTextColor(0, 0, 0); // Reset to black
            yPosition += 20;
            
            // Standard used
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text(`Standard Applied: ${standard}`, 20, yPosition);
            yPosition += 15;
            
            // Findings
            if (selectedFailuresList.length > 0) {
                pdf.setFont(undefined, 'bold');
                pdf.text('FINDINGS:', 20, yPosition);
                yPosition += 10;
                
                selectedFailuresList.forEach((failure, index) => {
                    pdf.setFont(undefined, 'bold');
                    pdf.text(`${index + 1}. ${failure.failure}`, 20, yPosition);
                    yPosition += 8;
                    
                    if (failure.comment) {
                        pdf.setFont(undefined, 'normal');
                        const commentLines = pdf.splitTextToSize(`Comment: ${failure.comment}`, 170);
                        pdf.text(commentLines, 25, yPosition);
                        yPosition += commentLines.length * 5;
                    }
                    
                    if (failure.imageData) {
                        pdf.setFont(undefined, 'italic');
                        pdf.text('Image:', 25, yPosition);
                        yPosition += 8;
                        const imageHeight = addImageToPDF(pdf, failure.imageData, 25, yPosition, 80, 60);
                        yPosition += imageHeight;
                    }
                    
                    yPosition += 5;
                    
                    // Add new page if needed
                    if (yPosition > 250) {
                        pdf.addPage();
                        yPosition = 20;
                        // Add footer to previous page
                        pdf.setPage(pdf.internal.getNumberOfPages() - 1);
                        pdf.setFontSize(8);
                        const footerLines = pdf.splitTextToSize(footer, 190);
                        pdf.text(footerLines, 105, 280, { align: 'center' });
                        pdf.setPage(pdf.internal.getNumberOfPages());
                        
                        // Add header logo to new page
                        if (uploadedImages['headerLogoPreview_data']) {
                            addImageToPDF(pdf, uploadedImages['headerLogoPreview_data'], 170, 10, 30, 15);
                        }
                    }
                });
            } else {
                pdf.setFont(undefined, 'normal');
                pdf.text('No earth resistance testing performed.', 20, yPosition);
                yPosition += 15;
            }
            
            // Final Comments
            if (finalComments) {
                yPosition += 10;
                pdf.setFont(undefined, 'bold');
                pdf.text('FINAL SUMMARY & RECOMMENDATIONS:', 20, yPosition);
                yPosition += 10;
                
                pdf.setFont(undefined, 'normal');
                const finalLines = pdf.splitTextToSize(finalComments, 170);
                pdf.text(finalLines, 20, yPosition);
            }d, 'normal');
                pdf.text('No faults identified during inspection.', 20, yPosition);
                yPosition += 10;
            }
            
            // Surge Protection Details
            yPosition += 10;
            pdf.setFont(undefined, 'bold');
            pdf.text('SURGE PROTECTION:', 20, yPosition);
            yPosition += 10;
            
            pdf.setFont(undefined, 'normal');
            pdf.text(`Installed: ${surgeInstalled}`, 20, yPosition);
            yPosition += 8;
            if (surgeInstalled === 'Yes') {
                pdf.text(`Type: ${surgeType}`, 20, yPosition);
                yPosition += 8;
                pdf.text(`Status: ${surgeSafe}`, 20, yPosition);
                yPosition += 8;
            }
            
            // General Comments
            if (generalComments) {
                yPosition += 10;
                pdf.setFont(undefined, 'bold');
                pdf.text('GENERAL COMMENTS:', 20, yPosition);
                yPosition += 10;
                
                pdf.setFont(undefined, 'normal');
                const commentLines = pdf.splitTextToSize(generalComments, 170);
                pdf.text(commentLines, 20, yPosition);
                yPosition += commentLines.length * 5 + 10;
            }
            
            // Page 3 - Earth Resistance Testing
            pdf.addPage();
            yPosition = 20;
            
            // Add header logo
            if (uploadedImages['headerLogoPreview_data']) {
                addImageToPDF(pdf, uploadedImages['headerLogoPreview_data'], 170, 10, 30, 15);
            }
            
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text('EARTH RESISTANCE TESTING', 20, yPosition);
            yPosition += 15;
            
            const numEarths = parseInt(document.getElementById('numEarths').value) || 0;
            if (numEarths > 0) {
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text('Individual Earth Readings:', 20, yPosition);
                yPosition += 10;
                
                pdf.setFont(undefined, 'normal');
                earthResistances.forEach((resistance, index) => {
                    pdf.text(`Earth ${index + 1}: ${resistance.toFixed(2)} Ω`, 20, yPosition);
                    yPosition += 8;
                });
                
                // Overall resistance
                if (earthResistances.some(r => r > 0)) {
                    const validResistances = earthResistances.filter(r => r > 0);
                    const reciprocalSum = validResistances.reduce((sum, r) => sum + (1/r), 0);
                    const overallResistance = 1 / reciprocalSum;
                    
                    yPosition += 10;
                    pdf.setFont(undefined, 'bold');
                    pdf.text(`Overall System Resistance: ${overallResistance.toFixed(3)} Ω`, 20, yPosition);
                    yPosition += 10;
                    
                    // Compliance check
                    pdf.setFont(undefined, 'normal');
                    if (overallResistance <= 10) {
                        pdf.setTextColor(34, 139, 34); // Green
                        pdf.text('✓ Complies with 10Ω requirement', 20, yPosition);
                    } else {
                        pdf.setTextColor(220, 20, 60); // Red
                        pdf.text('✗ Exceeds 10Ω requirement - FAIL', 20, yPosition);
                    }
                    pdf.setTextColor(0, 0, 0); // Reset to black
                    yPosition += 15;
                }
                
                // Earth test images
                if (uploadedImages['earthImagesPreview_data']) {
                    pdf.setFont(undefined, 'bold');
                    pdf.text('Earth Test Images:', 20, yPosition);
                    yPosition += 10;
                    
                    const images = Array.isArray(uploadedImages['earthImagesPreview_data']) ? 
                        uploadedImages['earthImagesPreview_data'] : [uploadedImages['earthImagesPreview_data']];
                    
                    images.forEach((imageData, index) => {
                        if (imageData && yPosition < 230) {
                            const imageHeight = addImageToPDF(pdf, imageData, 20, yPosition, 80, 60);
                            yPosition += imageHeight + 5;
                            
                            // Add new page if needed
                            if (yPosition > 230 && index < images.length - 1) {
                                pdf.addPage();
                                yPosition = 20;
                                if (uploadedImages['headerLogoPreview_data']) {
                                    addImageToPDF(pdf, uploadedImages['headerLogoPreview_data'], 170, 10, 30, 15);
                                }
                            }
                        }
                    });
                }
            } else {
                pdf.setFont(undefined, 'normal');
                pdf.text('No earth resistance testing performed.', 20, yPosition);
                yPosition += 15;
            }
            
            // Final Comments
            if (finalComments) {
                yPosition += 10;
                pdf.setFont(undefined, 'bold');
                pdf.text('FINAL SUMMARY & RECOMMENDATIONS:', 20, yPosition);
                yPosition += 10;
                
                pdf.setFont(undefined, 'normal');
                const finalLines = pdf.splitTextToSize(finalComments, 170);
                pdf.text(finalLines, 20, yPosition);
            }d, 'normal');
                pdf.text('No earth resistance testing performed.', 20, yPosition);
            }
            
            // Add footer to all pages except cover page
            const totalPages = pdf.internal.getNumberOfPages();
            for (let i = 2; i <= totalPages; i++) {
                pdf.setPage(i);
                pdf.setFontSize(8);
                const footerLines = pdf.splitTextToSize(footer, 190);
                pdf.text(footerLines, 105, 280, { align: 'center' });
            }
            
            // Generate filename
            const date = new Date().toISOString().split('T')[0];
            const filename = `Lightning_Protection_Report_${date}.pdf`;
            
            // Save the PDF
            pdf.save(filename);
        }
    </script>
</body>
</html>
