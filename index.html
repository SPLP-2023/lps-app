<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LPS Reporting Tool</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
            max-width: 1000px;
            margin: auto;
            background: #f9f9f9;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 6px;
        }
        
        .section h2 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        input, select, textarea, button {
            display: block;
            margin-bottom: 15px;
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        .btn-generate {
            background: #27ae60;
            font-size: 16px;
            padding: 15px;
        }
        
        .btn-generate:hover {
            background: #229954;
        }
        
        .standards-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .standards-list {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
        }
        
        .standard-item {
            padding: 10px;
            margin-bottom: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .standard-item:hover {
            background: #e3f2fd;
            border-color: #3498db;
        }
        
        .standard-item.selected {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        .standard-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .standard-description {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .failures-container {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            min-height: 300px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .failure-category {
            margin-bottom: 20px;
        }
        
        .failure-category h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            padding: 8px;
            background: #ecf0f1;
            border-radius: 4px;
        }
        
        .failure-item {
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .failure-item input[type="checkbox"] {
            width: auto;
            margin: 0;
            margin-top: 2px;
        }
        
        .failure-text {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .failure-citation {
            font-size: 12px;
            color: #666;
            font-style: italic;
            margin-top: 4px;
        }
        
        .selected-failures {
            margin-top: 20px;
        }
        
        .selected-failure {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .selected-failure h4 {
            margin: 0 0 10px 0;
            color: #856404;
        }
        
        .remove-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .remove-btn:hover {
            background: #c0392b;
        }
        
        .hidden {
            display: none;
        }
        
        .image-upload {
            margin-top: 10px;
        }
        
        .image-preview {
            max-width: 200px;
            max-height: 150px;
            margin-top: 10px;
            border-radius: 4px;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 5px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            margin-bottom: 0;
        }
        
        .checkbox-item label {
            margin-bottom: 0;
            font-weight: normal;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .standards-container {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>Lightning Protection System Reporting Tool</h1>
    
    <!-- Site Information Section -->
    <div class="section">
        <h2>Site Information</h2>
        <div class="form-row">
            <div class="form-group">
                <label for="engineerName">Engineer Name:</label>
                <input type="text" id="engineerName" placeholder="Enter engineer's name">
            </div>
            <div class="form-group">
                <label for="inspectionDate">Inspection Date:</label>
                <input type="date" id="inspectionDate">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="siteAddress">Site Address:</label>
                <textarea id="siteAddress" placeholder="Enter full site address" rows="3"></textarea>
                <label for="buildingImage">Building Image (Cover Photo):</label>
                <input type="file" id="buildingImage" accept="image/*" capture="environment" onchange="previewBuildingImage(event)">
                <img id="buildingImagePreview" class="image-preview" style="display: none;" alt="Building preview">
            </div>
            <div class="form-group">
                <label for="testKitNumber">Test Kit Number:</label>
                <input type="text" id="testKitNumber" placeholder="Enter test kit number">
                <label for="buildingReference">Building/Block Reference:</label>
                <input type="text" id="buildingReference" placeholder="Enter building reference">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="weatherConditions">Weather Conditions:</label>
                <input type="text" id="weatherConditions" placeholder="e.g., Dry, Damp, Wet">
            </div>
        </div>
    </div>
    
    <!-- System Description Section -->
    <div class="section">
        <h2>System Description</h2>
        <div class="form-row">
            <div class="form-group">
                <label>1. What is the ground type? (Multiple selections allowed)</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="ground_tarmac" name="groundType" value="Tarmac">
                        <label for="ground_tarmac">Tarmac</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="ground_concrete" name="groundType" value="Concrete">
                        <label for="ground_concrete">Concrete</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="ground_grass" name="groundType" value="Grass/Soil">
                        <label for="ground_grass">Grass/Soil</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="ground_slabs" name="groundType" value="Slabs">
                        <label for="ground_slabs">Slabs</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="ground_paving" name="groundType" value="Block Paving">
                        <label for="ground_paving">Block Paving</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="ground_other" name="groundType" value="Other" onchange="toggleOtherInput('ground_other_text', this)">
                        <label for="ground_other">Other</label>
                        <input type="text" id="ground_other_text" placeholder="Specify other ground type" style="display: none; margin-top: 5px;">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>2. Structure wall type? (Multiple selections allowed)</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="wall_brick" name="wallType" value="Brick">
                        <label for="wall_brick">Brick</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="wall_render" name="wallType" value="Render">
                        <label for="wall_render">Render</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="wall_metal" name="wallType" value="Metal Clad">
                        <label for="wall_metal">Metal Clad</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="wall_stone" name="wallType" value="Stone Block">
                        <label for="wall_stone">Stone Block</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="wall_wooden" name="wallType" value="Wooden Clad">
                        <label for="wall_wooden">Wooden Clad</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="wall_other" name="wallType" value="Other" onchange="toggleOtherInput('wall_other_text', this)">
                        <label for="wall_other">Other</label>
                        <input type="text" id="wall_other_text" placeholder="Specify other wall type" style="display: none; margin-top: 5px;">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>3. Roof type? (Multiple selections allowed)</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="roof_membrane" name="roofType" value="Membrane">
                        <label for="roof_membrane">Membrane</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="roof_felt" name="roofType" value="Felt">
                        <label for="roof_felt">Felt</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="roof_tile" name="roofType" value="Tile">
                        <label for="roof_tile">Tile</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="roof_metal" name="roofType" value="Metal Sheet">
                        <label for="roof_metal">Metal Sheet</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="roof_thatch" name="roofType" value="Thatch">
                        <label for="roof_thatch">Thatch</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="roof_other" name="roofType" value="Other" onchange="toggleOtherInput('roof_other_text', this)">
                        <label for="roof_other">Other</label>
                        <input type="text" id="roof_other_text" placeholder="Specify other roof type" style="display: none; margin-top: 5px;">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="structurePerimeter">4. Structure perimeter (meters):</label>
                <input type="number" id="structurePerimeter" placeholder="Enter perimeter in meters" min="0" step="0.1">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>5. Air-termination type? (Multiple selections allowed)</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="air_external_cage" name="airTermType" value="External Faraday Cage">
                        <label for="air_external_cage">External Faraday Cage</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="air_internal_cage" name="airTermType" value="Internal Faraday Cage">
                        <label for="air_internal_cage">Internal Faraday Cage</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="air_eseat" name="airTermType" value="ESEAT">
                        <label for="air_eseat">ESEAT</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="air_rolling" name="airTermType" value="Rolling Sphere">
                        <label for="air_rolling">Rolling Sphere</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="air_other" name="airTermType" value="Other" onchange="toggleOtherInput('air_other_text', this)">
                        <label for="air_other">Other</label>
                        <input type="text" id="air_other_text" placeholder="Specify other air-termination type" style="display: none; margin-top: 5px;">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>6. Down Conductor Type? (Multiple selections allowed)</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="down_external" name="downConductorType" value="External">
                        <label for="down_external">External</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="down_cavity" name="downConductorType" value="Cavity">
                        <label for="down_cavity">Cavity</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="down_internal" name="downConductorType" value="Internal">
                        <label for="down_internal">Internal</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="down_hvi" name="downConductorType" value="Isolated HVI">
                        <label for="down_hvi">Isolated HVI</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="down_other" name="downConductorType" value="Other" onchange="toggleOtherInput('down_other_text', this)">
                        <label for="down_other">Other</label>
                        <input type="text" id="down_other_text" placeholder="Specify other down conductor type" style="display: none; margin-top: 5px;">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>7. Conductor sizes? (Multiple selections allowed)</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="size_25x3" name="conductorSize" value="25x3mm">
                        <label for="size_25x3">25x3mm</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="size_8mm" name="conductorSize" value="8mm">
                        <label for="size_8mm">8mm</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="size_hvi" name="conductorSize" value="HVI">
                        <label for="size_hvi">HVI</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="size_20x3" name="conductorSize" value="20x3mm">
                        <label for="size_20x3">20x3mm</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="size_50x3" name="conductorSize" value="50x3mm">
                        <label for="size_50x3">50x3mm</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="size_other" name="conductorSize" value="Other" onchange="toggleOtherInput('size_other_text', this)">
                        <label for="size_other">Other</label>
                        <input type="text" id="size_other_text" placeholder="Specify other conductor size" style="display: none; margin-top: 5px;">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>8. Conductor coating? (Multiple selections allowed)</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="coating_pvc" name="conductorCoating" value="PVC">
                        <label for="coating_pvc">PVC</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="coating_bare" name="conductorCoating" value="Bare">
                        <label for="coating_bare">Bare</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="coating_brown" name="conductorCoating" value="Colour Brown">
                        <label for="coating_brown">Colour - Brown</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="coating_black" name="conductorCoating" value="Colour Black">
                        <label for="coating_black">Colour - Black</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="coating_grey" name="conductorCoating" value="Colour Grey">
                        <label for="coating_grey">Colour - Grey</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="coating_stone" name="conductorCoating" value="Colour Stone">
                        <label for="coating_stone">Colour - Stone</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="coating_white" name="conductorCoating" value="Colour White">
                        <label for="coating_white">Colour - White</label>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>9. SPD (Multiple selections allowed)</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="spd_present" name="spd" value="Present">
                        <label for="spd_present">Present</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="spd_unidentified" name="spd" value="Unidentified">
                        <label for="spd_unidentified">Unidentified</label>
                    </div>
                </div>
                
                <label style="margin-top: 15px;">10. SPD Type (Multiple selections allowed)</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="spd_type1" name="spdType" value="Type-1">
                        <label for="spd_type1">Type-1</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="spd_type2" name="spdType" value="Type-2">
                        <label for="spd_type2">Type-2</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="spd_type3" name="spdType" value="Type-3">
                        <label for="spd_type3">Type-3</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="spd_combined" name="spdType" value="Combined Unit">
                        <label for="spd_combined">Combined Unit</label>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>11. SPD Function (Multiple selections allowed)</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="spd_safe" name="spdFunction" value="Safe">
                        <label for="spd_safe">Safe</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="spd_unsafe" name="spdFunction" value="Unsafe">
                        <label for="spd_unsafe">Unsafe</label>
                    </div>
                </div>
                
                <label style="margin-top: 15px;">12. Main Equipotential Bond present? (Multiple selections allowed)</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="bond_present" name="mainBond" value="Present">
                        <label for="bond_present">Present</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="bond_unidentified" name="mainBond" value="Unidentified">
                        <label for="bond_unidentified">Unidentified</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="section">
        <h2>Standards and System Failures</h2>
        <label for="selectedStandard">Select Applicable Standard:</label>
        <select id="selectedStandard" onchange="updateFailuresList()">
            <option value="">-- Select Standard --</option>
            <option value="BSEN62305">BS EN 62305:2011 (Current Standard)</option>
            <option value="BS6651">BS 6651:1999 (Legacy Standard)</option>
            <option value="CP326">CP326 (Historical Standard)</option>
            <option value="NFC17102">NF C 17-102:2011 (French Standard)</option>
        </select>
        
        <div class="standards-container">
            <div>
                <h3>Standard Information</h3>
                <div id="standardInfo" class="standards-list">
                    <p style="text-align: center; color: #666; margin-top: 50px;">Select a standard to view details</p>
                </div>
            </div>
            
            <div>
                <h3>Available Failures/Non-Conformities</h3>
                <div id="failuresContainer" class="failures-container">
                    <p style="text-align: center; color: #666; margin-top: 100px;">Select a standard to view applicable failures</p>
                </div>
            </div>
        </div>
        
        <div id="selectedFailures" class="selected-failures hidden">
            <h3>Selected Failures</h3>
        </div>
    </div>
    
    <!-- Generate Report Section -->
    <div class="section">
        <button class="btn-generate" onclick="generatePDF()">Generate PDF Report</button>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        const { jsPDF } = window.jspdf;
        
        const standardsInfo = {
            'BSEN62305': {
                title: 'BS EN 62305:2011',
                subtitle: 'Protection against lightning',
                parts: [
                    'Part 1: General principles',
                    'Part 2: Risk management', 
                    'Part 3: Physical damage to structures and life hazard',
                    'Part 4: Electrical and electronic systems within structures'
                ],
                keyAreas: [
                    'Protection measures and LPS design',
                    'Air-termination systems',
                    'Down-conductor systems', 
                    'Earth-termination systems',
                    'Protection levels (I, II, III, IV)',
                    'Inspection and maintenance requirements'
                ]
            },
            'BS6651': {
                title: 'BS 6651:1999',
                subtitle: 'Code of practice for protection of structures against lightning',
                parts: [
                    'Lightning conductor systems',
                    'Protection of structures',
                    'Installation requirements',
                    'Testing and maintenance'
                ],
                keyAreas: [
                    'Material specifications',
                    'Earth electrode systems',
                    'Conductor sizing and installation',
                    'Inspection procedures'
                ]
            },
            'CP326': {
                title: 'CP326',
                subtitle: 'The Protection of Structures Against Lightning (Historical)',
                parts: [
                    'Basic lightning protection principles',
                    'Simple conductor systems',
                    'Earth electrode requirements'
                ],
                keyAreas: [
                    'Traditional lightning rod systems',
                    'Basic earthing requirements',
                    'Superseded by BS 6651'
                ]
            },
            'NFC17102': {
                title: 'NF C 17-102:2011',
                subtitle: 'Protection contre la foudre (French Standard)',
                parts: [
                    'Similar structure to BS EN 62305',
                    'Protection levels and risk assessment',
                    'Installation and testing requirements'
                ],
                keyAreas: [
                    'French regulatory compliance',
                    'Risk assessment methodologies',
                    'Maintenance schedules'
                ]
            }
        };
        
        const failuresData = {
            'BSEN62305': {
                'Air-Termination System': [
                    'Part 3, Section 5.2 - Insufficient protection coverage/angles exceeded',
                    'Part 3, Section 5.2 - Inadequate conductor cross-section (<50mm² Cu)',
                    'Part 3, Section 5.2 - Corrosion or physical damage to conductors',
                    'Part 3, Section 5.2 - Poor bonding of metallic roof elements',
                    'Part 3, Section 5.2 - Inadequate height above roof level'
                ],
                'Down-Conductor System': [
                    'Part 3, Section 5.3 - Insufficient number for structure perimeter',
                    'Part 3, Section 5.3 - Excessive spacing between conductors',
                    'Part 3, Section 5.3 - Sharp bends (radius <20cm)',
                    'Part 3, Section 5.3 - Inadequate separation from structure',
                    'Part 3, Section 5.3 - Missing mechanical protection'
                ],
                'Earth-Termination System': [
                    'Part 3, Section 5.4 - High earth resistance readings',
                    'Part 3, Section 5.4 - Insufficient electrode length',
                    'Part 3, Section 5.4 - Poor connections or corrosion',
                    'Part 3, Section 5.4 - Missing structural steelwork bonding'
                ],
                'General System Requirements': [
                    'Part 4 - Missing surge protection devices',
                    'Part 3 - Inadequate equipotential bonding',
                    'Part 2 - System not meeting protection level requirements',
                    'Part 3, Annex E - No evidence of annual inspection',
                    'General - Missing system drawings/certificates'
                ]
            },
            'BS6651': {
                'Lightning Conductor System': [
                    'Section 4 - Inadequate height protection',
                    'Section 4 - Insufficient cross-sectional area',
                    'Section 4 - Corrosion or physical damage',
                    'Section 4 - Poor workmanship in joints'
                ],
                'Down-Conductor System': [
                    'Section 5 - Improper installation path',
                    'Section 5 - Inadequate fixings and supports',
                    'Section 5 - Missing mechanical protection'
                ],
                'Earth Electrode System': [
                    'Section 6 - High resistance readings (>10Ω)',
                    'Section 6 - Insufficient electrode length',
                    'Section 6 - Poor earth connections'
                ],
                'General Requirements': [
                    'Section 8 - Missing metallic service bonding',
                    'Section 9 - No test results available',
                    'Section 3 - Non-compliant material specifications'
                ]
            },
            'CP326': [
                'Lightning rod: Inadequate protection cone',
                'Conductor: Insufficient gauge for application',
                'Earth connection: High resistance readings',
                'Installation: Poor workmanship standards',
                'Maintenance: No inspection records available'
            ],
            'NFC17102': [
                'Système de capture: Protection insuffisante',
                'Conducteurs de descente: Nombre insuffisant selon périmètre',
                'Prise de terre: Résistance élevée',
                'Liaisons équipotentielles: Manquantes ou défaillantes',
                'Parafoudres: Non conformes aux exigences',
                'Contrôles: Absence de vérifications périodiques'
            ]
        };
        
        let selectedFailures = [];
        let buildingImageData = null;
        
        function previewBuildingImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    buildingImageData = e.target.result;
                    const preview = document.getElementById('buildingImagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }
        
        function toggleOtherInput(textId, checkbox) {
            const textInput = document.getElementById(textId);
            if (checkbox.checked) {
                textInput.style.display = 'block';
                textInput.focus();
            } else {
                textInput.style.display = 'none';
                textInput.value = '';
            }
        }
        
        function getSelectedValues(groupName) {
            const checkboxes = document.querySelectorAll(`input[name="${groupName}"]:checked`);
            const values = [];
            checkboxes.forEach(cb => {
                if (cb.value === 'Other') {
                    const otherInput = cb.parentElement.querySelector('input[type="text"]');
                    if (otherInput && otherInput.value.trim()) {
                        values.push(`Other: ${otherInput.value.trim()}`);
                    }
                } else {
                    values.push(cb.value);
                }
            });
            return values;
        }
        
        function updateFailuresList() {
            const standard = document.getElementById('selectedStandard').value;
            const standardInfoDiv = document.getElementById('standardInfo');
            const failuresContainer = document.getElementById('failuresContainer');
            
            if (standard && standardsInfo[standard]) {
                // Update standard information
                const info = standardsInfo[standard];
                standardInfoDiv.innerHTML = `
                    <div class="standard-item selected">
                        <div class="standard-title">${info.title}</div>
                        <div class="standard-description">${info.subtitle}</div>
                    </div>
                    <div style="margin-top: 15px;">
                        <h4>Parts:</h4>
                        ${info.parts.map(part => `<div style="margin: 5px 0; padding-left: 10px;">• ${part}</div>`).join('')}
                        <h4 style="margin-top: 15px;">Key Areas:</h4>
                        ${info.keyAreas.map(area => `<div style="margin: 5px 0; padding-left: 10px;">• ${area}</div>`).join('')}
                    </div>
                `;
                
                // Update failures list
                if (failuresData[standard]) {
                    let failuresHtml = '';
                    const failures = failuresData[standard];
                    
                    if (Array.isArray(failures)) {
                        // For simple arrays (CP326, NFC17102)
                        failuresHtml = failures.map((failure, index) => `
                            <div class="failure-item">
                                <input type="checkbox" id="failure_${index}" onchange="toggleFailure('${failure}', this.checked)">
                                <div class="failure-text">${failure}</div>
                            </div>
                        `).join('');
                    } else {
                        // For categorized failures (BSEN62305, BS6651)
                        for (const [category, categoryFailures] of Object.entries(failures)) {
                            failuresHtml += `
                                <div class="failure-category">
                                    <h4>${category}</h4>
                                    ${categoryFailures.map((failure, index) => `
                                        <div class="failure-item">
                                            <input type="checkbox" id="failure_${category}_${index}" onchange="toggleFailure('${failure}', this.checked)">
                                            <div class="failure-text">${failure}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }
                    }
                    
                    failuresContainer.innerHTML = failuresHtml;
                } else {
                    failuresContainer.innerHTML = '<p style="text-align: center; color: #666; margin-top: 100px;">No failures data available for this standard</p>';
                }
            } else {
                standardInfoDiv.innerHTML = '<p style="text-align: center; color: #666; margin-top: 50px;">Select a standard to view details</p>';
                failuresContainer.innerHTML = '<p style="text-align: center; color: #666; margin-top: 100px;">Select a standard to view applicable failures</p>';
            }
            
            // Clear selected failures when changing standards
            selectedFailures = [];
            updateSelectedFailuresDisplay();
        }
        
        function toggleFailure(failureText, isSelected) {
            if (isSelected) {
                if (!selectedFailures.find(f => f.text === failureText)) {
                    selectedFailures.push({
                        id: Date.now() + Math.random(),
                        text: failureText,
                        notes: '',
                        image: null
                    });
                }
            } else {
                selectedFailures = selectedFailures.filter(f => f.text !== failureText);
            }
            updateSelectedFailuresDisplay();
        }
        
        function updateSelectedFailuresDisplay() {
            const container = document.getElementById('selectedFailures');
            
            if (selectedFailures.length === 0) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            const failuresHtml = selectedFailures.map(failure => `
                <div class="selected-failure">
                    <h4>${failure.text}</h4>
                    <label>Engineer Notes:</label>
                    <textarea placeholder="Add specific notes and recommendations..." onchange="updateFailureNotes(${failure.id}, this.value)">${failure.notes}</textarea>
                    <label>Photo Evidence:</label>
                    <input type="file" accept="image/*" capture="environment" onchange="handleImageUpload(${failure.id}, event)" class="image-upload">
                    ${failure.image ? `<img src="${failure.image}" class="image-preview" alt="Evidence photo">` : ''}
                    <button class="remove-btn" onclick="removeFailure(${failure.id})">Remove Failure</button>
                </div>
            `).join('');
            
            container.innerHTML = '<h3>Selected Failures</h3>' + failuresHtml;
        }
        
        function updateFailureNotes(failureId, notes) {
            const failure = selectedFailures.find(f => f.id === failureId);
            if (failure) {
                failure.notes = notes;
            }
        }
        
        function handleImageUpload(failureId, event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const failure = selectedFailures.find(f => f.id === failureId);
                    if (failure) {
                        failure.image = e.target.result;
                    const preview = document.getElementById('buildingImagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }
        
        function toggleOtherInput(textId, checkbox) {
            const textInput = document.getElementById(textId);
            if (checkbox.checked) {
                textInput.style.display = 'block';
                textInput.focus();
            } else {
                textInput.style.display = 'none';
                textInput.value = '';
            }
        }
        
        function getSelectedValues(groupName) {
            const checkboxes = document.querySelectorAll(`input[name="${groupName}"]:checked`);
            const values = [];
            checkboxes.forEach(cb => {
                if (cb.value === 'Other') {
                    const otherInput = cb.parentElement.querySelector('input[type="text"]');
                    if (otherInput && otherInput.value.trim()) {
                        values.push(`Other: ${otherInput.value.trim()}`);
                    }
                } else {
                    values.push(cb.value);
                }
            });
            return values;
        }
        
        function updateFailuresList() {
            const standard = document.getElementById('selectedStandard').value;
            const standardInfoDiv = document.getElementById('standardInfo');
            const failuresContainer = document.getElementById('failuresContainer');
            
            if (standard && standardsInfo[standard]) {
                // Update standard information
                const info = standardsInfo[standard];
                standardInfoDiv.innerHTML = `
                    <div class="standard-item selected">
                        <div class="standard-title">${info.title}</div>
                        <div class="standard-description">${info.subtitle}</div>
                    </div>
                    <div style="margin-top: 15px;">
                        <h4>Parts:</h4>
                        ${info.parts.map(part => `<div style="margin: 5px 0; padding-left: 10px;">• ${part}</div>`).join('')}
                        <h4 style="margin-top: 15px;">Key Areas:</h4>
                        ${info.keyAreas.map(area => `<div style="margin: 5px 0; padding-left: 10px;">• ${area}</div>`).join('')}
                    </div>
                `;
                
                // Update failures list
                if (failuresData[standard]) {
                    let failuresHtml = '';
                    const failures = failuresData[standard];
                    
                    if (Array.isArray(failures)) {
                        // For simple arrays (CP326, NFC17102)
                        failuresHtml = failures.map((failure, index) => `
                            <div class="failure-item">
                                <input type="checkbox" id="failure_${index}" onchange="toggleFailure('${failure}', this.checked)">
                                <div class="failure-text">${failure}</div>
                            </div>
                        `).join('');
                    } else {
                        // For categorized failures (BSEN62305, BS6651)
                        for (const [category, categoryFailures] of Object.entries(failures)) {
                            failuresHtml += `
                                <div class="failure-category">
                                    <h4>${category}</h4>
                                    ${categoryFailures.map((failure, index) => `
                                        <div class="failure-item">
                                            <input type="checkbox" id="failure_${category}_${index}" onchange="toggleFailure('${failure}', this.checked)">
                                            <div class="failure-text">${failure}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }
                    }
                    
                    failuresContainer.innerHTML = failuresHtml;
                } else {
                    failuresContainer.innerHTML = '<p style="text-align: center; color: #666; margin-top: 100px;">No failures data available for this standard</p>';
                }
            } else {
                standardInfoDiv.innerHTML = '<p style="text-align: center; color: #666; margin-top: 50px;">Select a standard to view details</p>';
                failuresContainer.innerHTML = '<p style="text-align: center; color: #666; margin-top: 100px;">Select a standard to view applicable failures</p>';
            }
            
            // Clear selected failures when changing standards
            selectedFailures = [];
            updateSelectedFailuresDisplay();
        }
        
        function toggleFailure(failureText, isSelected) {
            if (isSelected) {
                if (!selectedFailures.find(f => f.text === failureText)) {
                    selectedFailures.push({
                        id: Date.now() + Math.random(),
                        text: failureText,
                        notes: '',
                        image: null
                    });
                }
            } else {
                selectedFailures = selectedFailures.filter(f => f.text !== failureText);
            }
            updateSelectedFailuresDisplay();
        }
        
        function updateSelectedFailuresDisplay() {
            const container = document.getElementById('selectedFailures');
            
            if (selectedFailures.length === 0) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            const failuresHtml = selectedFailures.map(failure => `
                <div class="selected-failure">
                    <h4>${failure.text}</h4>
                    <label>Engineer Notes:</label>
                    <textarea placeholder="Add specific notes and recommendations..." onchange="updateFailureNotes(${failure.id}, this.value)">${failure.notes}</textarea>
                    <label>Photo Evidence:</label>
                    <input type="file" accept="image/*" capture="environment" onchange="handleImageUpload(${failure.id}, event)" class="image-upload">
                    ${failure.image ? `<img src="${failure.image}" class="image-preview" alt="Evidence photo">` : ''}
                    <button class="remove-btn" onclick="removeFailure(${failure.id})">Remove Failure</button>
                </div>
            `).join('');
            
            container.innerHTML = '<h3>Selected Failures</h3>' + failuresHtml;
        }
        
        function updateFailureNotes(failureId, notes) {
            const failure = selectedFailures.find(f => f.id === failureId);
            if (failure) {
                failure.notes = notes;
            }
        }
        
        function handleImageUpload(failureId, event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const failure = selectedFailures.find(f => f.id === failureId);
                    if (failure) {
                        failure.image = e.target.result;
                        updateSelectedFailuresDisplay();
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        
        function removeFailure(failureId) {
            selectedFailures = selectedFailures.filter(f => f.id !== failureId);
            updateSelectedFailuresDisplay();
            
            // Uncheck the corresponding checkbox
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                if (selectedFailures.find(f => f.text === cb.getAttribute('onchange')?.match(/'([^']+)'/)?.[1])) {
                    return;
                }
                cb.checked = false;
            });
        }
        
function generatePDF() {
    const doc = new jsPDF();
    const margin = 15;
    let y = 20; 

    // ===== PAGE 1: Header + Building Image + Details =====
    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    doc.text("Lightning Protection System Inspection Report", margin + 80, y);
    y += 20; 

    // Load site data
    const engineer = document.getElementById("engineerName").value || "-";
    const address = document.getElementById("siteAddress").value || "-";
    const date = document.getElementById("inspectionDate").value || "-";
    const testKit = document.getElementById("testKitNumber").value || "-";
    const reference = document.getElementById("buildingReference").value || "-";
    const weather = document.getElementById("weatherConditions").value || "-";
    const standard = document.getElementById("selectedStandard").value || "-"; 

    // Right side details
    const rightX = 100;
    const lineHeight = 10;
    y = 40; 

    doc.setFontSize(12);
    const addField = (label, value) => {
        doc.setFont('helvetica', 'bold');
        doc.text(`${label}:`, rightX, y);
        doc.setFont('helvetica', 'normal');
        doc.text(value, rightX + 40, y);
        y += lineHeight;
    }; 

    addField("Engineer", engineer);
    addField("Site Address", address);
    addField("Date", date);
    addField("Test Kit Number", testKit);
    addField("Building Ref", reference);
    addField("Weather", weather);
    addField("Standard", standard); 

    // Building image (circle with #00A0FF border)
    if (buildingImageData) {
        const imgSize = 60;
        const imgX = -20; // to make it go off the left edge
        const imgY = 50; 

        // Circle outline
        doc.setDrawColor(0, 160, 255);
        doc.setLineWidth(1.5);
        doc.circle(imgX + imgSize / 2 + 30, imgY + imgSize / 2, imgSize / 2 + 2); 

        // Clipping workaround (canvas render + mask simulation)
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const size = 200;
        canvas.width = size;
        canvas.height = size;
        const img = new Image();
        img.onload = () => {
            ctx.clearRect(0, 0, size, size);
            ctx.beginPath();
            ctx.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
            ctx.closePath();
            ctx.clip();
            ctx.drawImage(img, 0, 0, size, size);
            const clippedData = canvas.toDataURL('image/jpeg'); 

            doc.addImage(clippedData, 'JPEG', imgX, imgY, imgSize, imgSize);
            finalizePages();
        };
        img.src = buildingImageData;
    } else {
        finalizePages();
    } 

    function finalizePages() {
        // ===== PAGE 2: System Description Summary =====
        doc.addPage();
        y = 20;
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text("System Description Summary", margin, y);
        y += 10; 

        const sectionMap = {
            "Ground Type": getSelectedValues("groundType"),
            "Wall Type": getSelectedValues("wallType"),
            "Roof Type": getSelectedValues("roofType"),
            "Perimeter": document.getElementById("structurePerimeter").value + " meters",
            "Air-Termination": getSelectedValues("airTermType"),
            "Down Conductor": getSelectedValues("downConductorType"),
            "Conductor Sizes": getSelectedValues("conductorSize"),
            "Conductor Coating": getSelectedValues("conductorCoating"),
            "SPD": getSelectedValues("spd"),
            "SPD Type": getSelectedValues("spdType"),
            "SPD Function": getSelectedValues("spdFunction"),
            "Main Equipotential Bond": getSelectedValues("mainBond")
        }; 

        doc.setFontSize(11);
        for (const [label, value] of Object.entries(sectionMap)) {
            if (!value || (Array.isArray(value) && value.length === 0)) continue;
            const lines = doc.splitTextToSize(`${label}: ${Array.isArray(value) ? value.join(", ") : value}`, 180);
            lines.forEach(line => {
                if (y > 280) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(line, margin, y);
                y += 8;
            });
        } 

        // ===== PAGE 3+: Failures =====
        if (selectedFailures.length > 0) {
            doc.addPage();
            y = 20;
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text("System Failures and Non-Conformities", margin, y);
            y += 10; 

            selectedFailures.forEach((failure, index) => {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                } 

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(`Failure ${index + 1}:`, margin, y);
                y += 6; 

                doc.setFont('helvetica', 'normal');
                const failureLines = doc.splitTextToSize(failure.text, 170);
                failureLines.forEach(line => {
                    doc.text(line, margin, y);
                    y += 6;
                }); 

                if (failure.notes) {
                    y += 3;
                    doc.setFont('helvetica', 'bold');
                    doc.text("Engineer Notes:", margin, y);
                    y += 6;
                    doc.setFont('helvetica', 'normal');
                    const notesLines = doc.splitTextToSize(failure.notes, 170);
                    notesLines.forEach(line => {
                        doc.text(line, margin, y);
                        y += 6;
                    });
                } 

                if (failure.image) {
                    if (y > 200) {
                        doc.addPage();
                        y = 20;
                    }
                    const imgProps = doc.getImageProperties(failure.image);
                    const imgWidth = 80;
                    const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                    doc.addImage(failure.image, 'JPEG', margin, y, imgWidth, imgHeight);
                    y += imgHeight + 10;
                } 

                y += 10;
            });
        } 

        // Add footer
        addFooter(doc);
        doc.save("LPS_Inspection_Report.pdf");
    }
}
        
        function addFooter(doc) {
            const pageCount = doc.getNumberOfPages();
            const footerText = "Strike Point Lightning Protection Ltd - Registered office: Atkinson & Evans Ltd, 10 Arnot Hill Road, Nottingham NG5 6LJ.\nCompany No. 15114852, Registered in England and Wales. @: info@strikepoint.uk Tel: 0115 990 3220";
            
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                const lines = doc.splitTextToSize(footerText, 180);
                let footerY = 290 - (lines.length - 1) * 4;
                lines.forEach(line => {
                    doc.text(line, 105, footerY, { align: 'center' });
                    footerY += 4;
                });
            }
        }
        
        // Set today's date by default
        document.getElementById('inspectionDate').valueAsDate = new Date();
    </script>
</body>
</html>
