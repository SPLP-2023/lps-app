<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LPS Reporting Tool</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
            max-width: 1000px;
            margin: auto;
            background: #f9f9f9;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 6px;
        }
        
        .section h2 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        input, select, textarea, button {
            display: block;
            margin-bottom: 15px;
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        .btn-generate {
            background: #27ae60;
            font-size: 16px;
            padding: 15px;
        }
        
        .btn-generate:hover {
            background: #229954;
        }
        
        .standards-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .standards-list {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
        }
        
        .standard-item {
            padding: 10px;
            margin-bottom: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .standard-item:hover {
            background: #e3f2fd;
            border-color: #3498db;
        }
        
        .standard-item.selected {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        .standard-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .standard-description {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .failures-container {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            min-height: 300px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .failure-category {
            margin-bottom: 20px;
        }
        
        .failure-category h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            padding: 8px;
            background: #ecf0f1;
            border-radius: 4px;
        }
        
        .failure-item {
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .failure-item input[type="checkbox"] {
            width: auto;
            margin: 0;
            margin-top: 2px;
        }
        
        .failure-text {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .failure-citation {
            font-size: 12px;
            color: #666;
            font-style: italic;
            margin-top: 4px;
        }
        
        .selected-failures {
            margin-top: 20px;
        }
        
        .selected-failure {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .selected-failure h4 {
            margin: 0 0 10px 0;
            color: #856404;
        }
        
        .remove-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .remove-btn:hover {
            background: #c0392b;
        }
        
        .hidden {
            display: none;
        }
        
        .image-upload {
            margin-top: 10px;
        }
        
        .image-preview {
            max-width: 200px;
            max-height: 150px;
            margin-top: 10px;
            border-radius: 4px;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 5px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            margin-bottom: 0;
        }
        
        .checkbox-item label {
            margin-bottom: 0;
            font-weight: normal;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .standards-container {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>Lightning Protection System Reporting Tool</h1>
    
    <!-- Site Information Section -->
    <div class="section">
        <h2>Site Information</h2>
        <div class="form-row">
            <div class="form-group">
                <label for="engineerName">Engineer Name:</label>
                <input type="text" id="engineerName" placeholder="Enter engineer's name">
            </div>
            <div class="form-group">
                <label for="inspectionDate">Inspection Date:</label>
                <input type="date" id="inspectionDate">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="siteAddress">Site Address:</label>
                <textarea id="siteAddress" placeholder="Enter full site address" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="testKitNumber">Test Kit Number:</label>
                <input type="text" id="testKitNumber" placeholder="Enter test kit number">
                <label for="buildingReference">Building/Block Reference:</label>
                <input type="text" id="buildingReference" placeholder="Enter building reference">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="weatherConditions">Weather Conditions:</label>
                <input type="text" id="weatherConditions" placeholder="e.g., Dry, Damp, Wet">
            </div>
        </div>
    </div>
    
    <!-- Standards and Failures Section -->
    <div class="section">
        <h2>Standards and System Failures</h2>
        <label for="selectedStandard">Select Applicable Standard:</label>
        <select id="selectedStandard" onchange="updateFailuresList()">
            <option value="">-- Select Standard --</option>
            <option value="BSEN62305">BS EN 62305:2011 (Current Standard)</option>
            <option value="BS6651">BS 6651:1999 (Legacy Standard)</option>
            <option value="CP326">CP326 (Historical Standard)</option>
            <option value="NFC17102">NF C 17-102:2011 (French Standard)</option>
        </select>
        
        <div class="standards-container">
            <div>
                <h3>Standard Information</h3>
                <div id="standardInfo" class="standards-list">
                    <p style="text-align: center; color: #666; margin-top: 50px;">Select a standard to view details</p>
                </div>
            </div>
            
            <div>
                <h3>Available Failures/Non-Conformities</h3>
                <div id="failuresContainer" class="failures-container">
                    <p style="text-align: center; color: #666; margin-top: 100px;">Select a standard to view applicable failures</p>
                </div>
            </div>
        </div>
        
        <div id="selectedFailures" class="selected-failures hidden">
            <h3>Selected Failures</h3>
        </div>
    </div>
    
    <!-- Generate Report Section -->
    <div class="section">
        <button class="btn-generate" onclick="generatePDF()">Generate PDF Report</button>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        const { jsPDF } = window.jspdf;
        
        const standardsInfo = {
            'BSEN62305': {
                title: 'BS EN 62305:2011',
                subtitle: 'Protection against lightning',
                parts: [
                    'Part 1: General principles',
                    'Part 2: Risk management', 
                    'Part 3: Physical damage to structures and life hazard',
                    'Part 4: Electrical and electronic systems within structures'
                ],
                keyAreas: [
                    'Protection measures and LPS design',
                    'Air-termination systems',
                    'Down-conductor systems', 
                    'Earth-termination systems',
                    'Protection levels (I, II, III, IV)',
                    'Inspection and maintenance requirements'
                ]
            },
            'BS6651': {
                title: 'BS 6651:1999',
                subtitle: 'Code of practice for protection of structures against lightning',
                parts: [
                    'Lightning conductor systems',
                    'Protection of structures',
                    'Installation requirements',
                    'Testing and maintenance'
                ],
                keyAreas: [
                    'Material specifications',
                    'Earth electrode systems',
                    'Conductor sizing and installation',
                    'Inspection procedures'
                ]
            },
            'CP326': {
                title: 'CP326',
                subtitle: 'The Protection of Structures Against Lightning (Historical)',
                parts: [
                    'Basic lightning protection principles',
                    'Simple conductor systems',
                    'Earth electrode requirements'
                ],
                keyAreas: [
                    'Traditional lightning rod systems',
                    'Basic earthing requirements',
                    'Superseded by BS 6651'
                ]
            },
            'NFC17102': {
                title: 'NF C 17-102:2011',
                subtitle: 'Protection contre la foudre (French Standard)',
                parts: [
                    'Similar structure to BS EN 62305',
                    'Protection levels and risk assessment',
                    'Installation and testing requirements'
                ],
                keyAreas: [
                    'French regulatory compliance',
                    'Risk assessment methodologies',
                    'Maintenance schedules'
                ]
            }
        };
        
        const failuresData = {
            'BSEN62305': {
                'Air-Termination System': [
                    'Part 3, Section 5.2 - Insufficient protection coverage/angles exceeded',
                    'Part 3, Section 5.2 - Inadequate conductor cross-section (<50mm² Cu)',
                    'Part 3, Section 5.2 - Corrosion or physical damage to conductors',
                    'Part 3, Section 5.2 - Poor bonding of metallic roof elements',
                    'Part 3, Section 5.2 - Inadequate height above roof level'
                ],
                'Down-Conductor System': [
                    'Part 3, Section 5.3 - Insufficient number for structure perimeter',
                    'Part 3, Section 5.3 - Excessive spacing between conductors',
                    'Part 3, Section 5.3 - Sharp bends (radius <20cm)',
                    'Part 3, Section 5.3 - Inadequate separation from structure',
                    'Part 3, Section 5.3 - Missing mechanical protection'
                ],
                'Earth-Termination System': [
                    'Part 3, Section 5.4 - High earth resistance readings',
                    'Part 3, Section 5.4 - Insufficient electrode length',
                    'Part 3, Section 5.4 - Poor connections or corrosion',
                    'Part 3, Section 5.4 - Missing structural steelwork bonding'
                ],
                'General System Requirements': [
                    'Part 4 - Missing surge protection devices',
                    'Part 3 - Inadequate equipotential bonding',
                    'Part 2 - System not meeting protection level requirements',
                    'Part 3, Annex E - No evidence of annual inspection',
                    'General - Missing system drawings/certificates'
                ]
            },
            'BS6651': {
                'Lightning Conductor System': [
                    'Section 4 - Inadequate height protection',
                    'Section 4 - Insufficient cross-sectional area',
                    'Section 4 - Corrosion or physical damage',
                    'Section 4 - Poor workmanship in joints'
                ],
                'Down-Conductor System': [
                    'Section 5 - Improper installation path',
                    'Section 5 - Inadequate fixings and supports',
                    'Section 5 - Missing mechanical protection'
                ],
                'Earth Electrode System': [
                    'Section 6 - High resistance readings (>10Ω)',
                    'Section 6 - Insufficient electrode length',
                    'Section 6 - Poor earth connections'
                ],
                'General Requirements': [
                    'Section 8 - Missing metallic service bonding',
                    'Section 9 - No test results available',
                    'Section 3 - Non-compliant material specifications'
                ]
            },
            'CP326': [
                'Lightning rod: Inadequate protection cone',
                'Conductor: Insufficient gauge for application',
                'Earth connection: High resistance readings',
                'Installation: Poor workmanship standards',
                'Maintenance: No inspection records available'
            ],
            'NFC17102': [
                'Système de capture: Protection insuffisante',
                'Conducteurs de descente: Nombre insuffisant selon périmètre',
                'Prise de terre: Résistance élevée',
                'Liaisons équipotentielles: Manquantes ou défaillantes',
                'Parafoudres: Non conformes aux exigences',
                'Contrôles: Absence de vérifications périodiques'
            ]
        };
        
        let selectedFailures = [];
        
        function updateFailuresList() {
            const standard = document.getElementById('selectedStandard').value;
            const standardInfoDiv = document.getElementById('standardInfo');
            const failuresContainer = document.getElementById('failuresContainer');
            
            if (standard && standardsInfo[standard]) {
                // Update standard information
                const info = standardsInfo[standard];
                standardInfoDiv.innerHTML = `
                    <div class="standard-item selected">
                        <div class="standard-title">${info.title}</div>
                        <div class="standard-description">${info.subtitle}</div>
                    </div>
                    <div style="margin-top: 15px;">
                        <h4>Parts:</h4>
                        ${info.parts.map(part => `<div style="margin: 5px 0; padding-left: 10px;">• ${part}</div>`).join('')}
                        <h4 style="margin-top: 15px;">Key Areas:</h4>
                        ${info.keyAreas.map(area => `<div style="margin: 5px 0; padding-left: 10px;">• ${area}</div>`).join('')}
                    </div>
                `;
                
                // Update failures list
                if (failuresData[standard]) {
                    let failuresHtml = '';
                    const failures = failuresData[standard];
                    
                    if (Array.isArray(failures)) {
                        // For simple arrays (CP326, NFC17102)
                        failuresHtml = failures.map((failure, index) => `
                            <div class="failure-item">
                                <input type="checkbox" id="failure_${index}" onchange="toggleFailure('${failure}', this.checked)">
                                <div class="failure-text">${failure}</div>
                            </div>
                        `).join('');
                    } else {
                        // For categorized failures (BSEN62305, BS6651)
                        for (const [category, categoryFailures] of Object.entries(failures)) {
                            failuresHtml += `
                                <div class="failure-category">
                                    <h4>${category}</h4>
                                    ${categoryFailures.map((failure, index) => `
                                        <div class="failure-item">
                                            <input type="checkbox" id="failure_${category}_${index}" onchange="toggleFailure('${failure}', this.checked)">
                                            <div class="failure-text">${failure}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }
                    }
                    
                    failuresContainer.innerHTML = failuresHtml;
                } else {
                    failuresContainer.innerHTML = '<p style="text-align: center; color: #666; margin-top: 100px;">No failures data available for this standard</p>';
                }
            } else {
                standardInfoDiv.innerHTML = '<p style="text-align: center; color: #666; margin-top: 50px;">Select a standard to view details</p>';
                failuresContainer.innerHTML = '<p style="text-align: center; color: #666; margin-top: 100px;">Select a standard to view applicable failures</p>';
            }
            
            // Clear selected failures when changing standards
            selectedFailures = [];
            updateSelectedFailuresDisplay();
        }
        
        function toggleFailure(failureText, isSelected) {
            if (isSelected) {
                if (!selectedFailures.find(f => f.text === failureText)) {
                    selectedFailures.push({
                        id: Date.now() + Math.random(),
                        text: failureText,
                        notes: '',
                        image: null
                    });
                }
            } else {
                selectedFailures = selectedFailures.filter(f => f.text !== failureText);
            }
            updateSelectedFailuresDisplay();
        }
        
        function updateSelectedFailuresDisplay() {
            const container = document.getElementById('selectedFailures');
            
            if (selectedFailures.length === 0) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            const failuresHtml = selectedFailures.map(failure => `
                <div class="selected-failure">
                    <h4>${failure.text}</h4>
                    <label>Engineer Notes:</label>
                    <textarea placeholder="Add specific notes and recommendations..." onchange="updateFailureNotes(${failure.id}, this.value)">${failure.notes}</textarea>
                    <label>Photo Evidence:</label>
                    <input type="file" accept="image/*" capture="environment" onchange="handleImageUpload(${failure.id}, event)" class="image-upload">
                    ${failure.image ? `<img src="${failure.image}" class="image-preview" alt="Evidence photo">` : ''}
                    <button class="remove-btn" onclick="removeFailure(${failure.id})">Remove Failure</button>
                </div>
            `).join('');
            
            container.innerHTML = '<h3>Selected Failures</h3>' + failuresHtml;
        }
        
        function updateFailureNotes(failureId, notes) {
            const failure = selectedFailures.find(f => f.id === failureId);
            if (failure) {
                failure.notes = notes;
            }
        }
        
        function handleImageUpload(failureId, event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const failure = selectedFailures.find(f => f.id === failureId);
                    if (failure) {
                        failure.image = e.target.result;
                        updateSelectedFailuresDisplay();
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        
        function removeFailure(failureId) {
            selectedFailures = selectedFailures.filter(f => f.id !== failureId);
            updateSelectedFailuresDisplay();
            
            // Uncheck the corresponding checkbox
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                if (selectedFailures.find(f => f.text === cb.getAttribute('onchange')?.match(/'([^']+)'/)?.[1])) {
                    return;
                }
                cb.checked = false;
            });
        }
        
        function generatePDF() {
            const doc = new jsPDF();
            let y = 20;
            const margin = 15;
            const lineHeight = 8;
            
            function addText(title, value) {
                doc.setFont('helvetica', 'bold');
                doc.text(title + ":", margin, y);
                doc.setFont('helvetica', 'normal');
                doc.text(value || '-', margin + 50, y);
                y += lineHeight;
            }
            
            // Page 1: Header and Basic Info
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text("Lightning Protection System Inspection Report", margin, y);
            y += 15;
            
            doc.setFontSize(11);
            addText("Engineer", document.getElementById("engineerName").value);
            addText("Site Address", document.getElementById("siteAddress").value);
            addText("Date", document.getElementById("inspectionDate").value);
            addText("Test Kit Number", document.getElementById("testKitNumber").value);
            addText("Building Reference", document.getElementById("buildingReference").value);
            addText("Weather Conditions", document.getElementById("weatherConditions").value);
            addText("Standard Tested To", document.getElementById("selectedStandard").value);
            
            y += 10;
            
            // Failures section
            if (selectedFailures.length > 0) {
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text("System Failures and Non-Conformities", margin, y);
                y += 10;
                
                selectedFailures.forEach((failure, index) => {
                    if (y > 250) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Failure ${index + 1}:`, margin, y);
                    y += 6;
                    
                    doc.setFont('helvetica', 'normal');
                    const failureLines = doc.splitTextToSize(failure.text, 170);
                    failureLines.forEach(line => {
                        doc.text(line, margin, y);
                        y += 6;
                    });
                    
                    if (failure.notes) {
                        y += 3;
                        doc.setFont('helvetica', 'bold');
                        doc.text("Engineer Notes:", margin, y);
                        y += 6;
                        doc.setFont('helvetica', 'normal');
                        const notesLines = doc.splitTextToSize(failure.notes, 170);
                        notesLines.forEach(line => {
                            doc.text(line, margin, y);
                            y += 6;
                        });
                    }
                    
                    if (failure.image) {
                        if (y > 200) {
                            doc.addPage();
                            y = 20;
                        }
                        const imgProps = doc.getImageProperties(failure.image);
                        const imgWidth = 80;
                        const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                        doc.addImage(failure.image, 'JPEG', margin, y, imgWidth, imgHeight);
                        y += imgHeight + 10;
                    }
                    
                    y += 10;
                });
            } else {
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text("Inspection Result", margin, y);
                y += 10;
                
                doc.setFont('helvetica', 'normal');
                doc.text("No failures or non-conformities identified during this inspection.", margin, y);
                y += 6;
                doc.text("The lightning protection system appears to be compliant with the selected standard.", margin, y);
            }
            
            // Add footer to all pages
            addFooter(doc);
            
            doc.save("LPS_Inspection_Report.pdf");
        }
        
        function addFooter(doc) {
            const pageCount = doc.getNumberOfPages();
            const footerText = "Strike Point Lightning Protection Ltd - Registered office: Atkinson & Evans Ltd, 10 Arnot Hill Road, Nottingham NG5 6LJ.\nCompany No. 15114852, Registered in England and Wales. @: info@strikepoint.uk Tel: 0115 990 3220";
            
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                const lines = doc.splitTextToSize(footerText, 180);
                let footerY = 290 - (lines.length - 1) * 4;
                lines.forEach(line => {
                    doc.text(line, 105, footerY, { align: 'center' });
                    footerY += 4;
                });
            }
        }
        
        // Set today's date by default
        document.getElementById('inspectionDate').valueAsDate = new Date();
    </script>
</body>
</html>
