<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lightning Protection Engineers Reporting Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f4f4f4;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .section h2 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }
        
        input[type="text"], input[type="date"], input[type="number"], select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        button {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        .earth-inputs {
            display: none;
            margin-top: 15px;
        }
        
        .earth-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .earth-input-group input {
            width: 120px;
        }
        
        .failure-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .failure-item h4 {
            color: #dc3545;
            margin-bottom: 10px;
        }
        
        .image-upload {
            border: 2px dashed #dee2e6;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .image-upload:hover {
            border-color: #007bff;
        }
        
        .result-display {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .result-display h4 {
            color: #0c5460;
            margin-bottom: 10px;
        }
        
        .standards-dropdown {
            margin-bottom: 20px;
        }
        
        .failures-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background: white;
        }
        
        .failure-option {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .failure-option:hover {
            background-color: #f8f9fa;
        }
        
        .failure-option.selected {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        
        #generateReport {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            margin-top: 30px;
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
        }
        
        .hidden {
            display: none;
        }
        
        .collapsible-container {
            margin-bottom: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .collapsible-header {
            width: 100%;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: none;
            padding: 15px;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            color: #495057;
            transition: background-color 0.3s;
        }
        
        .collapsible-header:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }
        
        .collapsible-content {
            display: none;
            padding: 15px;
            background-color: #fff;
            border-top: 1px solid #dee2e6;
        }
        
        .collapsible-content.active {
            display: block;
        }
        
        .reference-list {
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .reference-list ul {
            padding-left: 20px;
        }
        
        .reference-list li {
            margin-bottom: 5px;
        }

        @media print {
            .container {
                box-shadow: none;
                max-width: none;
                margin: 0;
                padding: 10px;
            }
            
            button {
                display: none;
            }
            
            .reference-section {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>⚡ Lightning Protection Engineers Reporting Tool</h1>
        
        <!-- Collapsible Reference Sections -->
        <div class="section">
            <h2>📚 Standards Reference Guide</h2>
            
            <div class="collapsible-container">
                <button class="collapsible-header" onclick="toggleCollapsible('bs62305')">
                    📋 BS EN 62305 Structure & Requirements
                </button>
                <div id="bs62305" class="collapsible-content">
                    <div class="reference-list">
                        <strong>BS EN 62305-1: General Principles</strong>
                        <ul>
                            <li>Lightning Protection Levels (LPL I-IV)</li>
                            <li>Current division principles</li>
                            <li>Lightning Protection Zones (LPZ 0A, 0B, 1, 2)</li>
                            <li>Protection methods and concepts</li>
                        </ul>
                        <strong>BS EN 62305-2: Risk Management</strong>
                        <ul>
                            <li>Risk assessment procedures</li>
                            <li>R1: Risk of loss of human life</li>
                            <li>R2: Risk of loss of service to public</li>
                            <li>R3: Risk of loss of cultural heritage</li>
                            <li>R4: Risk of economic loss</li>
                        </ul>
                        <strong>BS EN 62305-3: Physical Damage to Structures</strong>
                        <ul>
                            <li>Air termination systems</li>
                            <li>Down conductor systems</li>
                            <li>Earth termination systems (Type A & B)</li>
                            <li>Equipotential bonding</li>
                            <li>Separation distances</li>
                            <li>Material specifications</li>
                        </ul>
                        <strong>BS EN 62305-4: Electrical and Electronic Systems</strong>
                        <ul>
                            <li>Surge Protection Devices (SPDs)</li>
                            <li>Lightning current arresters</li>
                            <li>Overvoltage surge arresters</li>
                            <li>Coordinated SPD protection</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="collapsible-container">
                <button class="collapsible-header" onclick="toggleCollapsible('bs6651')">
                    📋 BS 6651 Structure (Legacy Standard)
                </button>
                <div id="bs6651" class="collapsible-content">
                    <div class="reference-list">
                        <ul>
                            <li>Section 1: Scope and definitions</li>
                            <li>Section 2: Risk factor analysis</li>
                            <li>Section 3: Air termination</li>
                            <li>Section 4: Down conductors</li>
                            <li>Section 5: Earth termination</li>
                            <li>Section 6: Bonding and surge protection</li>
                            <li>Section 7: Materials and construction</li>
                            <li>Section 8: Installation requirements</li>
                            <li>Section 9: Inspection and testing</li>
                            <li>Section 10: Maintenance</li>
                            <li>Annexes A-F: Additional guidance</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="collapsible-container">
                <button class="collapsible-header" onclick="toggleCollapsible('failures')">
                    📋 Common System Failures & Test Requirements
                </button>
                <div id="failures" class="collapsible-content">
                    <div class="reference-list">
                        <strong>Typical Failures:</strong>
                        <ul>
                            <li>Earth resistance above acceptable limits (>10Ω typically)</li>
                            <li>Poor continuity between components</li>
                            <li>Corrosion of conductors/connections</li>
                            <li>Missing or damaged air terminals</li>
                            <li>Inadequate equipotential bonding</li>
                            <li>Non-compliant materials used</li>
                            <li>Insufficient separation distances</li>
                            <li>SPD failures or missing devices</li>
                        </ul>
                        <strong>Test Requirements:</strong>
                        <ul>
                            <li>Visual inspection (annual minimum)</li>
                            <li>Earth resistance testing</li>
                            <li>Continuity testing</li>
                            <li>SPD functional testing</li>
                            <li>Documentation verification</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Basic Information Section -->
        <div class="section">
            <h2>📝 Site Information</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="siteAddress">Site Address:</label>
                    <textarea id="siteAddress" rows="3" placeholder="Enter full site address..."></textarea>
                </div>
                <div class="form-group">
                    <label for="testDate">Date:</label>
                    <input type="date" id="testDate">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="engineerName">Engineer Name:</label>
                    <input type="text" id="engineerName" placeholder="Enter engineer name...">
                </div>
                <div class="form-group">
                    <label for="testKitRef">Test Kit Reference:</label>
                    <input type="text" id="testKitRef" placeholder="Enter test kit reference...">
                </div>
            </div>
            <div class="form-group">
                <label for="buildingImage">Building Image (Cover Page):</label>
                <div class="image-upload" onclick="document.getElementById('buildingImageFile').click()">
                    <input type="file" id="buildingImageFile" accept="image/*" style="display: none;" onchange="handleImageUpload(this, 'buildingImagePreview')">
                    <div id="buildingImagePreview">Click to upload building image</div>
                </div>
            </div>
        </div>

        <!-- Standards Selection -->
        <div class="section">
            <h2>📖 Standard Selection & Failures</h2>
            <div class="form-group standards-dropdown">
                <label for="standard">Select Standard:</label>
                <select id="standard" onchange="updateFailuresList()">
                    <option value="">Select a standard...</option>
                    <option value="BS EN 62305">BS EN 62305 (Current Standard)</option>
                    <option value="BS 6651">BS 6651 (Legacy Standard)</option>
                    <option value="CP 326">CP 326 (Historical Standard)</option>
                    <option value="NF C 17-102">NF C 17-102:2011 (ESE Systems)</option>
                </select>
            </div>
            <div id="failuresContainer" class="hidden">
                <label>Available Failures for Selected Standard:</label>
                <div id="failuresList" class="failures-list"></div>
            </div>
        </div>

        <!-- Selected Failures -->
        <div class="section">
            <h2>⚠️ Selected Failures & Comments</h2>
            <div id="selectedFailures"></div>
        </div>

        <!-- General Comments Section -->
        <div class="section">
            <h2>💬 General Comments</h2>
            <div class="form-group">
                <label for="generalComments">Additional Comments:</label>
                <textarea id="generalComments" rows="4" placeholder="Enter any additional observations, recommendations, or general comments about the lightning protection system..."></textarea>
            </div>
        </div>

        <!-- Structure Details Section -->
        <div class="section">
            <h2>🏢 Structure Details</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="structureHeight">Structure Height (m):</label>
                    <input type="number" id="structureHeight" step="0.1" min="0" placeholder="0.0">
                </div>
                <div class="form-group">
                    <label for="structurePerimeter">Structure Perimeter (m):</label>
                    <input type="number" id="structurePerimeter" step="0.1" min="0" placeholder="0.0">
                </div>
            </div>

            <div class="form-group">
                <label>1. What is the ground type?</label>
                <div id="groundTypeList" class="failures-list">
                    <div class="failure-option" onclick="selectSystemDetail('groundType', 'Tarmac', this)">Tarmac</div>
                    <div class="failure-option" onclick="selectSystemDetail('groundType', 'Concrete', this)">Concrete</div>
                    <div class="failure-option" onclick="selectSystemDetail('groundType', 'Grass', this)">Grass</div>
                    <div class="failure-option" onclick="selectSystemDetail('groundType', 'Soil', this)">Soil</div>
                    <div class="failure-option" onclick="selectSystemDetail('groundType', 'Gravel Slabs', this)">Gravel Slabs</div>
                    <div class="failure-option" onclick="selectSystemDetail('groundType', 'Block Paving', this)">Block Paving</div>
                    <div class="failure-option" onclick="selectSystemDetail('groundType', 'Other', this, true)">Other</div>
                </div>
                <input type="text" id="groundTypeOther" class="hidden" placeholder="Please specify..." onchange="updateOtherValue('groundType', this.value)">
            </div>

            <div class="form-group">
                <label>2. What is the structure wall type?</label>
                <div id="wallTypeList" class="failures-list">
                    <div class="failure-option" onclick="selectSystemDetail('wallType', 'Brick', this)">Brick</div>
                    <div class="failure-option" onclick="selectSystemDetail('wallType', 'Render', this)">Render</div>
                    <div class="failure-option" onclick="selectSystemDetail('wallType', 'Metal Clad', this)">Metal Clad</div>
                    <div class="failure-option" onclick="selectSystemDetail('wallType', 'Wooden Clad', this)">Wooden Clad</div>
                    <div class="failure-option" onclick="selectSystemDetail('wallType', 'Composite Clad', this)">Composite Clad</div>
                    <div class="failure-option" onclick="selectSystemDetail('wallType', 'Glazing', this)">Glazing</div>
                    <div class="failure-option" onclick="selectSystemDetail('wallType', 'Stone Block', this)">Stone Block</div>
                    <div class="failure-option" onclick="selectSystemDetail('wallType', 'Other', this, true)">Other</div>
                </div>
                <input type="text" id="wallTypeOther" class="hidden" placeholder="Please specify..." onchange="updateOtherValue('wallType', this.value)">
            </div>

            <div class="form-group">
                <label>3. What is the Roof type?</label>
                <div id="roofTypeList" class="failures-list">
                    <div class="failure-option" onclick="selectSystemDetail('roofType', 'Felt', this)">Felt</div>
                    <div class="failure-option" onclick="selectSystemDetail('roofType', 'Membrane', this)">Membrane</div>
                    <div class="failure-option" onclick="selectSystemDetail('roofType', 'Metal Clad', this)">Metal Clad</div>
                    <div class="failure-option" onclick="selectSystemDetail('roofType', 'Tiles', this)">Tiles</div>
                    <div class="failure-option" onclick="selectSystemDetail('roofType', 'Lead', this)">Lead</div>
                    <div class="failure-option" onclick="selectSystemDetail('roofType', 'Thatch', this)">Thatch</div>
                    <div class="failure-option" onclick="selectSystemDetail('roofType', 'Concrete', this)">Concrete</div>
                    <div class="failure-option" onclick="selectSystemDetail('roofType', 'Other', this, true)">Other</div>
                </div>
                <input type="text" id="roofTypeOther" class="hidden" placeholder="Please specify..." onchange="updateOtherValue('roofType', this.value)">
            </div>

            <div class="form-group">
                <label>4. What is the Roof Structure?</label>
                <div id="roofStructureList" class="failures-list">
                    <div class="failure-option" onclick="selectSystemDetail('roofStructure', 'Pitched', this)">Pitched</div>
                    <div class="failure-option" onclick="selectSystemDetail('roofStructure', 'Domed', this)">Domed</div>
                    <div class="failure-option" onclick="selectSystemDetail('roofStructure', 'Flat', this)">Flat</div>
                    <div class="failure-option" onclick="selectSystemDetail('roofStructure', 'Complex', this)">Complex</div>
                    <div class="failure-option" onclick="selectSystemDetail('roofStructure', 'Other', this, true)">Other</div>
                </div>
                <input type="text" id="roofStructureOther" class="hidden" placeholder="Please specify..." onchange="updateOtherValue('roofStructure', this.value)">
            </div>
        </div>

        <!-- System Details Section -->
        <div class="section">
            <h2>🏗️ System Details</h2>
            
            <div class="form-group">
                <label>1. Air-Termination type</label>
                <div id="airTerminationList" class="failures-list">
                    <div class="failure-option" onclick="selectSystemDetail('airTermination', 'Externally fitted Faraday Cage', this)">Externally fitted Faraday Cage</div>
                    <div class="failure-option" onclick="selectSystemDetail('airTermination', 'ESEAT', this)">ESEAT</div>
                    <div class="failure-option" onclick="selectSystemDetail('airTermination', 'Conductive Sheet & Cappings', this)">Conductive Sheet & Cappings</div>
                    <div class="failure-option" onclick="selectSystemDetail('airTermination', 'Finial Rods', this)">Finial Rods</div>
                    <div class="failure-option" onclick="selectSystemDetail('airTermination', 'HVI Installation', this)">HVI Installation</div>
                    <div class="failure-option" onclick="selectSystemDetail('airTermination', 'Other', this, true)">Other</div>
                </div>
                <input type="text" id="airTerminationOther" class="hidden" placeholder="Please specify..." onchange="updateOtherValue('airTermination', this.value)">
            </div>

            <div class="form-group">
                <label>2. AT Conductors</label>
                <div id="atConductorsList" class="failures-list">
                    <div class="failure-option" onclick="selectSystemDetail('atConductors', '25x3mm PVC Black', this)">25x3mm PVC Black</div>
                    <div class="failure-option" onclick="selectSystemDetail('atConductors', '25x3mm PVC Grey', this)">25x3mm PVC Grey</div>
                    <div class="failure-option" onclick="selectSystemDetail('atConductors', '25x3mm PVC Stone', this)">25x3mm PVC Stone</div>
                    <div class="failure-option" onclick="selectSystemDetail('atConductors', '25x3mm PVC Brown', this)">25x3mm PVC Brown</div>
                    <div class="failure-option" onclick="selectSystemDetail('atConductors', '25x3mm PVC White', this)">25x3mm PVC White</div>
                    <div class="failure-option" onclick="selectSystemDetail('atConductors', '25x3mm Bare', this)">25x3mm Bare</div>
                    <div class="failure-option" onclick="selectSystemDetail('atConductors', '8mm PVC Black', this)">8mm PVC Black</div>
                    <div class="failure-option" onclick="selectSystemDetail('atConductors', '8mm PVC Grey', this)">8mm PVC Grey</div>
                    <div class="failure-option" onclick="selectSystemDetail('atConductors', '8mm PVC Stone', this)">8mm PVC Stone</div>
                    <div class="failure-option" onclick="selectSystemDetail('atConductors', '8mm PVC Brown', this)">8mm PVC Brown</div>
                    <div class="failure-option" onclick="selectSystemDetail('atConductors', '8mm PVC White', this)">8mm PVC White</div>
                    <div class="failure-option" onclick="selectSystemDetail('atConductors', '8mm Bare', this)">8mm Bare</div>
                    <div class="failure-option" onclick="selectSystemDetail('atConductors', 'Other', this, true)">Other</div>
                </div>
                <input type="text" id="atConductorsOther" class="hidden" placeholder="Please specify..." onchange="updateOtherValue('atConductors', this.value)">
            </div>

            <div class="form-group">
                <label>3. Down Conductor Type</label>
                <div id="downConductorTypeList" class="failures-list">
                    <div class="failure-option" onclick="selectSystemDetail('downConductorType', 'Externally fitted Conductors', this)">Externally fitted Conductors</div>
                    <div class="failure-option" onclick="selectSystemDetail('downConductorType', 'Cavity Conductors', this)">Cavity Conductors</div>
                    <div class="failure-option" onclick="selectSystemDetail('downConductorType', 'Internal Framework', this)">Internal Framework</div>
                    <div class="failure-option" onclick="selectSystemDetail('downConductorType', 'Other', this, true)">Other</div>
                </div>
                <input type="text" id="downConductorTypeOther" class="hidden" placeholder="Please specify..." onchange="updateOtherValue('downConductorType', this.value)">
            </div>

            <div class="form-group">
                <label>4. DC Conductors</label>
                <div id="dcConductorsList" class="failures-list">
                    <div class="failure-option" onclick="selectSystemDetail('dcConductors', '25x3mm PVC Black', this)">25x3mm PVC Black</div>
                    <div class="failure-option" onclick="selectSystemDetail('dcConductors', '25x3mm PVC Grey', this)">25x3mm PVC Grey</div>
                    <div class="failure-option" onclick="selectSystemDetail('dcConductors', '25x3mm PVC Stone', this)">25x3mm PVC Stone</div>
                    <div class="failure-option" onclick="selectSystemDetail('dcConductors', '25x3mm PVC Brown', this)">25x3mm PVC Brown</div>
                    <div class="failure-option" onclick="selectSystemDetail('dcConductors', '25x3mm PVC White', this)">25x3mm PVC White</div>
                    <div class="failure-option" onclick="selectSystemDetail('dcConductors', '25x3mm Bare', this)">25x3mm Bare</div>
                    <div class="failure-option" onclick="selectSystemDetail('dcConductors', '8mm PVC Black', this)">8mm PVC Black</div>
                    <div class="failure-option" onclick="selectSystemDetail('dcConductors', '8mm PVC Grey', this)">8mm PVC Grey</div>
                    <div class="failure-option" onclick="selectSystemDetail('dcConductors', '8mm PVC Stone', this)">8mm PVC Stone</div>
                    <div class="failure-option" onclick="selectSystemDetail('dcConductors', '8mm PVC Brown', this)">8mm PVC Brown</div>
                    <div class="failure-option" onclick="selectSystemDetail('dcConductors', '8mm PVC White', this)">8mm PVC White</div>
                    <div class="failure-option" onclick="selectSystemDetail('dcConductors', '8mm Bare', this)">8mm Bare</div>
                    <div class="failure-option" onclick="selectSystemDetail('dcConductors', 'HVI Single', this)">HVI Single</div>
                    <div class="failure-option" onclick="selectSystemDetail('dcConductors', 'HVI Multiple', this)">HVI Multiple</div>
                    <div class="failure-option" onclick="selectSystemDetail('dcConductors', 'Framework (Steel Columns)', this)">Framework (Steel Columns)</div>
                    <div class="failure-option" onclick="selectSystemDetail('dcConductors', 'Framework (Steel Reinforcing Bars)', this)">Framework (Steel Reinforcing Bars)</div>
                    <div class="failure-option" onclick="selectSystemDetail('dcConductors', 'Other', this, true)">Other</div>
                </div>
                <input type="text" id="dcConductorsOther" class="hidden" placeholder="Please specify..." onchange="updateOtherValue('dcConductors', this.value)">
            </div>

            <div class="form-group">
                <label>5. Earth Pits</label>
                <select id="earthPits">
                    <option value="">Select...</option>
                    <option value="Concrete">Concrete</option>
                    <option value="Polymer">Polymer</option>
                    <option value="None">None</option>
                </select>
            </div>

            <div class="form-group">
                <label>6. Main Equipotential Bond</label>
                <select id="mainEquipotentialBond">
                    <option value="">Select...</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                    <option value="Unidentified">Unidentified</option>
                </select>
            </div>

            <div class="form-group">
                <label>7. Surge Protection Installed</label>
                <select id="surgeInstalled">
                    <option value="">Select...</option>
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                </select>
            </div>

            <div class="form-group">
                <label>8. Surge Protection Type</label>
                <input type="text" id="surgeType" placeholder="e.g., Type 1, Type 2, Combined...">
            </div>

            <div class="form-group">
                <label>9. Surge Protection Safety Status</label>
                <select id="surgeSafe">
                    <option value="">Select...</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                    <option value="Requires Further Investigation">Requires Further Investigation</option>
                </select>
            </div>
        </div>

        <!-- Earth Resistance Testing -->
        <div class="section">
            <h2>🌍 Earth Resistance Testing</h2>
            <div class="form-group">
                <label for="numEarths">Number of Earths Tested:</label>
                <input type="number" id="numEarths" min="0" max="20" onchange="generateEarthInputs()">
            </div>
            <div id="earthInputs" class="earth-inputs"></div>
            <div id="earthResult" class="result-display hidden">
                <h4>Overall Earth Resistance:</h4>
                <div id="overallResistance"></div>
            </div>
            <div class="form-group">
                <label for="earthImages">Earth Test Images:</label>
                <div class="image-upload" onclick="document.getElementById('earthImagesFile').click()">
                    <input type="file" id="earthImagesFile" accept="image/*" multiple style="display: none;" onchange="handleMultipleImageUpload(this, 'earthImagesPreview')">
                    <div id="earthImagesPreview">Click to upload earth test images</div>
                </div>
            </div>
        </div>

        <!-- Logo Upload Section -->
        <div class="section">
            <h2>🏢 Company Branding</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="coverLogo">Cover Page Logo (Large):</label>
                    <div class="image-upload" onclick="document.getElementById('coverLogoFile').click()">
                        <input type="file" id="coverLogoFile" accept="image/*" style="display: none;" onchange="handleImageUpload(this, 'coverLogoPreview')">
                        <div id="coverLogoPreview">Click to upload cover page logo</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="headerLogo">Header Logo (Small):</label>
                    <div class="image-upload" onclick="document.getElementById('headerLogoFile').click()">
                        <input type="file" id="headerLogoFile" accept="image/*" style="display: none;" onchange="handleImageUpload(this, 'headerLogoPreview')">
                        <div id="headerLogoPreview">Click to upload header logo</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Final Comments Section -->
        <div class="section">
            <h2>📝 Final Summary Comments</h2>
            <div class="form-group">
                <label for="finalComments">Summary & Recommendations:</label>
                <textarea id="finalComments" rows="4" placeholder="Enter final summary, conclusions, and recommendations for the lightning protection system..."></textarea>
            </div>
        </div>

        <!-- Generate Report Button -->
        <button id="generateReport" onclick="generatePDF()">🎯 Generate Professional PDF Report</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Comprehensive failure definitions by standard with references
        const standardFailures = {
            "BS EN 62305": [
                { failure: "Earth resistance exceeds 10 Ohm requirement", ref: "BS EN 62305-3, Section 5.4.2" },
                { failure: "Poor continuity between air terminals and down conductors", ref: "BS EN 62305-3, Section 5.2.1" },
                { failure: "Air terminals not meeting LPL requirements", ref: "BS EN 62305-3, Section 5.2.2, Table 2" },
                { failure: "Down conductors not following shortest route to earth", ref: "BS EN 62305-3, Section 5.3.1" },
                { failure: "Inadequate separation distance from metalwork", ref: "BS EN 62305-3, Section 6.3" },
                { failure: "Missing equipotential bonding connections", ref: "BS EN 62305-3, Section 6.2" },
                { failure: "Non-compliant conductor materials or dimensions", ref: "BS EN 62305-3, Section 5.5, Table 3" },
                { failure: "Earth termination system Type A/B non-compliance", ref: "BS EN 62305-3, Section 5.4.1" },
                { failure: "Missing or inadequate surge protection devices", ref: "BS EN 62305-4, Section 6" },
                { failure: "SPD coordination issues between protection levels", ref: "BS EN 62305-4, Section 7.3" },
                { failure: "Insufficient lightning protection zones implementation", ref: "BS EN 62305-4, Section 4" },
                { failure: "Risk assessment not conducted or outdated", ref: "BS EN 62305-2, Section 4" },
                { failure: "Missing bonds to external metalwork", ref: "BS EN 62305-3, Section 6.2.1" },
                { failure: "Corrosion exceeding acceptable limits", ref: "BS EN 62305-3, Section 5.5.4" },
                { failure: "Mechanical damage to system components", ref: "BS EN 62305-3, Section 5.5.3" },
                { failure: "Installation not meeting Class I/II/III/IV requirements", ref: "BS EN 62305-3, Section 5.1, Table 1" },
                { failure: "Missing test clamps or inspection facilities", ref: "BS EN 62305-3, Section 7.1" },
                { failure: "Documentation incomplete or missing", ref: "BS EN 62305-3, Section 8" },
                { failure: "Non-compliance with manufacturer specifications", ref: "BS EN 62305-3, Section 5.5.1" },
                { failure: "Environmental protection inadequate", ref: "BS EN 62305-3, Section 5.5.3" }
            ],
            "BS 6651": [
                { failure: "Earth electrode resistance above 10 Ohm", ref: "BS 6651, Section 13.2" },
                { failure: "Continuity failure in conductor network", ref: "BS 6651, Section 9.1" },
                { failure: "Air terminal spacing exceeds 20m/25m limits", ref: "BS 6651, Section 7.2" },
                { failure: "Down conductor route not direct to earth", ref: "BS 6651, Section 8.1" },
                { failure: "Missing side-flash protection bonds", ref: "BS 6651, Section 14.1" },
                { failure: "Conductor cross-sectional area insufficient", ref: "BS 6651, Section 6.2, Table 1" },
                { failure: "Earth electrode depth/installation inadequate", ref: "BS 6651, Section 13.1" },
                { failure: "Joint resistance exceeding 0.05 Ohm", ref: "BS 6651, Section 9.2" },
                { failure: "Missing surge diverter protection", ref: "BS 6651, Annex C" },
                { failure: "Corrosion affecting system integrity", ref: "BS 6651, Section 6.3" },
                { failure: "Mechanical protection inadequate", ref: "BS 6651, Section 6.4" },
                { failure: "Test facilities not provided", ref: "BS 6651, Section 33.1" },
                { failure: "Risk factor calculation not meeting 10^-5 limit", ref: "BS 6651, Section 4.1" },
                { failure: "Material specifications non-compliant", ref: "BS 6651, Section 6.1, Table 1" },
                { failure: "Missing bonds to metallic services", ref: "BS 6651, Section 14.2" },
                { failure: "Down conductor count insufficient for building size", ref: "BS 6651, Section 8.2" },
                { failure: "Air terminal height inadequate for protection", ref: "BS 6651, Section 7.1" },
                { failure: "Missing isolation joints where required", ref: "BS 6651, Section 14.3" },
                { failure: "Installation records incomplete", ref: "BS 6651, Section 34.1" },
                { failure: "Maintenance schedule not followed", ref: "BS 6651, Section 34.2" }
            ],
            "CP 326": [
                { failure: "Non-compliance with basic protection principles", ref: "CP 326, Section 2" },
                { failure: "Inadequate conductor sizing for historic requirements", ref: "CP 326, Section 3.1" },
                { failure: "Missing earth connections", ref: "CP 326, Section 4" },
                { failure: "Poor workmanship in installations", ref: "CP 326, Section 5" },
                { failure: "Material degradation beyond acceptable limits", ref: "CP 326, Section 3.2" },
                { failure: "Insufficient protection coverage", ref: "CP 326, Section 2.1" },
                { failure: "Missing documentation from original installation", ref: "CP 326, Section 6" },
                { failure: "Non-standard component usage", ref: "CP 326, Section 3.3" },
                { failure: "Inadequate maintenance records", ref: "CP 326, Section 6.1" },
                { failure: "System modifications without proper design review", ref: "CP 326, Section 5.1" }
            ],
            "NF C 17-102": [
                { failure: "ESE efficiency (DT) not verified or inadequate", ref: "NF C 17-102, Section 5.2.2" },
                { failure: "Protection radius calculation errors", ref: "NF C 17-102, Section 5.2.3, Equation 1" },
                { failure: "Air terminal not meeting ESE testing requirements", ref: "NF C 17-102, Section 6.1" },
                { failure: "Down conductor installation non-compliant", ref: "NF C 17-102, Section 5.3" },
                { failure: "Earth resistance exceeding French standard limits", ref: "NF C 17-102, Section 5.4" },
                { failure: "ESE device not certified to NF C 17-102", ref: "NF C 17-102, Section 4.1" },
                { failure: "Missing surge protection coordination", ref: "NF C 17-102, Section 5.5" },
                { failure: "Equipotential bonding inadequate", ref: "NF C 17-102, Section 5.4.2" },
                { failure: "Installation height calculations incorrect", ref: "NF C 17-102, Section 5.2.3" },
                { failure: "Early streamer emission timing not verified", ref: "NF C 17-102, Section 6.2.1" },
                { failure: "Protection level selection inappropriate", ref: "NF C 17-102, Section 5.2.1" },
                { failure: "Missing risk assessment per French requirements", ref: "NF C 17-102, Section 5.1" },
                { failure: "EMC compliance issues with electronic ESE devices", ref: "NF C 17-102, Section 6.4" },
                { failure: "Mechanical strength testing not verified", ref: "NF C 17-102, Section 6.3" },
                { failure: "Current withstand capability not proven", ref: "NF C 17-102, Section 6.2.2" },
                { failure: "Protection zone overlap insufficient", ref: "NF C 17-102, Section 5.2.4" },
                { failure: "Installation not meeting manufacturer requirements", ref: "NF C 17-102, Section 7" },
                { failure: "Missing periodic testing verification", ref: "NF C 17-102, Section 8" },
                { failure: "Documentation not in French standard format", ref: "NF C 17-102, Section 9" },
                { failure: "System commissioning incomplete", ref: "NF C 17-102, Section 7.1" }
            ]
        };

        let selectedFailuresList = [];
        let earthResistances = [];
        let uploadedImages = {};
        let systemDetails = {};

        // Set today's date as default
        document.getElementById('testDate').valueAsDate = new Date();

        function toggleCollapsible(id) {
            const content = document.getElementById(id);
            content.classList.toggle('active');
        }

        function selectSystemDetail(category, value, element, isOther = false) {
            if (!systemDetails[category]) {
                systemDetails[category] = [];
            }
            
            if (element.classList.contains('selected')) {
                element.classList.remove('selected');
                systemDetails[category] = systemDetails[category].filter(item => item !== value);
                
                if (isOther) {
                    document.getElementById(category + 'Other').classList.add('hidden');
                    document.getElementById(category + 'Other').value = '';
                }
            } else {
                element.classList.add('selected');
                if (!systemDetails[category].includes(value)) {
                    systemDetails[category].push(value);
                }
                
                if (isOther) {
                    document.getElementById(category + 'Other').classList.remove('hidden');
                }
            }
        }

        function updateOtherValue(category, value) {
            if (!systemDetails[category]) {
                systemDetails[category] = [];
            }
            
            systemDetails[category] = systemDetails[category].filter(item => !item.startsWith('Other:'));
            
            if (value.trim()) {
                systemDetails[category].push('Other: ' + value.trim());
            }
        }

        function updateFailuresList() {
            const standard = document.getElementById('standard').value;
            const container = document.getElementById('failuresContainer');
            const failuresList = document.getElementById('failuresList');
            
            if (standard && standardFailures[standard]) {
                container.classList.remove('hidden');
                failuresList.innerHTML = '';
                
                standardFailures[standard].forEach((failureObj, index) => {
                    const failureDiv = document.createElement('div');
                    failureDiv.className = 'failure-option';
                    failureDiv.textContent = failureObj.failure;
                    failureDiv.onclick = () => selectFailure(failureObj, failureDiv);
                    failuresList.appendChild(failureDiv);
                });
            } else {
                container.classList.add('hidden');
            }
        }

        function selectFailure(failureObj, element) {
            if (element.classList.contains('selected')) {
                element.classList.remove('selected');
                selectedFailuresList = selectedFailuresList.filter(f => f.failure !== failureObj.failure);
            } else {
                element.classList.add('selected');
                selectedFailuresList.push({
                    failure: failureObj.failure,
                    reference: failureObj.ref,
                    comment: '',
                    image: null
                });
            }
            updateSelectedFailures();
        }

        function updateSelectedFailures() {
            const container = document.getElementById('selectedFailures');
            container.innerHTML = '';
            
            selectedFailuresList.forEach((item, index) => {
                const failureDiv = document.createElement('div');
                failureDiv.className = 'failure-item';
                failureDiv.innerHTML = `
                    <h4>${item.failure}</h4>
                    <div style="font-size: 12px; color: #6c757d; margin: 5px 0; font-style: italic;">${item.reference}</div>
                    <div class="form-group">
                        <label>Comment:</label>
                        <textarea onchange="updateFailureComment(${index}, this.value)" placeholder="Add detailed comments about this failure...">${item.comment}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Image:</label>
                        <div class="image-upload" onclick="document.getElementById('failureImage${index}').click()">
                            <input type="file" id="failureImage${index}" accept="image/*" style="display: none;" onchange="handleFailureImage(${index}, this)">
                            <div id="failureImagePreview${index}">${item.image ? 'Image uploaded' : 'Click to upload image'}</div>
                        </div>
                    </div>
                `;
                container.appendChild(failureDiv);
            });
        }

        function updateFailureComment(index, comment) {
            selectedFailuresList[index].comment = comment;
        }

        function handleFailureImage(index, input) {
            if (input.files[0]) {
                const file = input.files[0];
                selectedFailuresList[index].image = file;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedFailuresList[index].imageData = e.target.result;
                };
                reader.readAsDataURL(file);
                
                document.getElementById(`failureImagePreview${index}`).textContent = 'Image uploaded';
            }
        }

        function generateEarthInputs() {
            const numEarths = parseInt(document.getElementById('numEarths').value) || 0;
            const container = document.getElementById('earthInputs');
            
            if (numEarths > 0) {
                container.style.display = 'block';
                container.innerHTML = '<h4>Enter Earth Resistance Values (Ohm):</h4>';
                
                for (let i = 1; i <= numEarths; i++) {
                    const inputGroup = document.createElement('div');
                    inputGroup.className = 'earth-input-group';
                    inputGroup.innerHTML = `
                        <label>Earth ${i}:</label>
                        <input type="number" step="0.01" min="0" onchange="updateEarthResistance(${i-1}, this.value)" placeholder="0.00">
                        <span>Ohm</span>
                    `;
                    container.appendChild(inputGroup);
                }
                earthResistances = new Array(numEarths).fill(0);
            } else {
                container.style.display = 'none';
                document.getElementById('earthResult').classList.add('hidden');
            }
        }

        function updateEarthResistance(index, value) {
            earthResistances[index] = parseFloat(value) || 0;
            calculateOverallResistance();
        }

        function calculateOverallResistance() {
            if (earthResistances.length > 0 && earthResistances.some(r => r > 0)) {
                const validResistances = earthResistances.filter(r => r > 0);
                const reciprocalSum = validResistances.reduce((sum, r) => sum + (1/r), 0);
                const overallResistance = 1 / reciprocalSum;
                
                document.getElementById('earthResult').classList.remove('hidden');
                document.getElementById('overallResistance').innerHTML = `
                    <strong>${overallResistance.toFixed(3)} Ohm</strong>
                    <br><small>Calculated from ${validResistances.length} earth electrode(s)</small>
                `;
            } else {
                document.getElementById('earthResult').classList.add('hidden');
            }
        }

        function handleImageUpload(input, previewId) {
            if (input.files[0]) {
                const file = input.files[0];
                uploadedImages[previewId] = file;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedImages[previewId + '_data'] = e.target.result;
                };
                reader.readAsDataURL(file);
                
                document.getElementById(previewId).textContent = 'Image uploaded successfully';
            }
        }

        function handleMultipleImageUpload(input, previewId) {
            if (input.files.length > 0) {
                const files = Array.from(input.files);
                uploadedImages[previewId] = files;
                uploadedImages[previewId + '_data'] = [];
                
                files.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        uploadedImages[previewId + '_data'][index] = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
                
                document.getElementById(previewId).textContent = `${input.files.length} image(s) uploaded`;
            }
        }

        function addImageToPDF(pdf, imageData, x, y, maxWidth, maxHeight) {
            if (imageData) {
                try {
                    const format = imageData.includes('data:image/jpeg') ? 'JPEG' : 'PNG';
                    pdf.addImage(imageData, format, x, y, maxWidth, maxHeight);
                    return maxHeight + 10;
                } catch (error) {
                    console.error('Error adding image to PDF:', error);
                    return 0;
                }
            }
            return 0;
        }
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            const footer = "Strike Point Lightning Protection Ltd Registered office: Atkinson Evans, 10 Arnot Hill Road, Nottingham NG5 6LJ. Company No. 15114852, Registered in England and Wales. @: info@strikepoint.uk Tel: 01159903220";
            
            // Helper function to check and add new page if needed
            function checkNewPage(currentY, threshold = 250) {
                if (currentY > threshold) {
                    // Add footer to current page
                    const currentPage = pdf.internal.getNumberOfPages();
                    pdf.setPage(currentPage);
                    pdf.setFontSize(8);
                    const footerLines = pdf.splitTextToSize(footer, 190);
                    pdf.text(footerLines, 105, 280, { align: 'center' });
                    
                    // Add new page
                    pdf.addPage();
                    
                    // Add header logo to new page
                    if (uploadedImages['headerLogoPreview_data']) {
                        addImageToPDF(pdf, uploadedImages['headerLogoPreview_data'], 170, 10, 30, 15);
                    }
                    
                    return 30; // Return new Y position for new page
                }
                return currentY;
            }
            
            // Get form data
            const siteAddress = document.getElementById('siteAddress').value;
            const testDate = document.getElementById('testDate').value;
            const engineerName = document.getElementById('engineerName').value;
            const testKitRef = document.getElementById('testKitRef').value;
            const standard = document.getElementById('standard').value;
            const generalComments = document.getElementById('generalComments').value;
            const finalComments = document.getElementById('finalComments').value;
            
            // Get structure details
            const structureHeight = document.getElementById('structureHeight').value;
            const structurePerimeter = document.getElementById('structurePerimeter').value;
            
            // Get system details dropdowns
            const earthPits = document.getElementById('earthPits').value;
            const mainEquipotentialBond = document.getElementById('mainEquipotentialBond').value;
            const surgeInstalled = document.getElementById('surgeInstalled').value;
            const surgeType = document.getElementById('surgeType').value;
            const surgeSafe = document.getElementById('surgeSafe').value;
            
            let yPosition = 20;
            
            // Page 1 - Cover Page (No changes needed)
            if (uploadedImages['coverLogoPreview_data']) {
                const logoHeight = addImageToPDF(pdf, uploadedImages['coverLogoPreview_data'], 60, 20, 90, 40);
                yPosition = 70;
            } else {
                yPosition = 30;
            }
            
            pdf.setFontSize(24);
            pdf.setFont(undefined, 'bold');
            pdf.text('Lightning Protection System Report', 105, yPosition, { align: 'center' });
            yPosition += 30;
            
            if (uploadedImages['buildingImagePreview_data']) {
                const imageHeight = addImageToPDF(pdf, uploadedImages['buildingImagePreview_data'], 30, yPosition, 150, 100);
                yPosition += imageHeight + 20;
            }
            
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('Site Details:', 105, yPosition, { align: 'center' });
            yPosition += 20;
            
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'normal');
            const details = [
                'Site Address: ' + siteAddress,
                'Date: ' + testDate,
                'Engineer: ' + engineerName,
                'Test Kit Reference: ' + testKitRef
            ];
            
            details.forEach((detail, index) => {
                pdf.text(detail, 105, yPosition + (index * 10), { align: 'center' });
            });
            
            // START INSPECTION SUMMARY SECTION
            pdf.addPage();
            yPosition = 20;
            
            if (uploadedImages['headerLogoPreview_data']) {
                addImageToPDF(pdf, uploadedImages['headerLogoPreview_data'], 170, 10, 30, 15);
            }
            
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text('INSPECTION SUMMARY', 20, yPosition);
            yPosition += 15;
            
            const hasFaults = selectedFailuresList.length > 0;
            pdf.setFontSize(14);
            if (hasFaults) {
                pdf.setTextColor(220, 20, 60);
                pdf.text('RESULT: FAIL', 20, yPosition);
            } else {
                pdf.setTextColor(34, 139, 34);
                pdf.text('RESULT: PASS', 20, yPosition);
            }
            pdf.setTextColor(0, 0, 0);
            yPosition += 20;
            
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('Standard Applied: ' + standard, 20, yPosition);
            yPosition += 15;
            
            if (selectedFailuresList.length > 0) {
                pdf.setFont(undefined, 'bold');
                pdf.text('FINDINGS:', 20, yPosition);
                yPosition += 10;
                
                selectedFailuresList.forEach((failure, index) => {
                    // Check if we need a new page before adding failure
                    yPosition = checkNewPage(yPosition, 220);
                    
                    pdf.setFont(undefined, 'bold');
                    pdf.text((index + 1) + '. ' + failure.failure, 20, yPosition);
                    yPosition += 8;
                    
                    pdf.setFont(undefined, 'italic');
                    pdf.setFontSize(10);
                    pdf.text('Reference: ' + failure.reference, 25, yPosition);
                    yPosition += 8;
                    pdf.setFontSize(12);
                    
                    if (failure.comment) {
                        pdf.setFont(undefined, 'normal');
                        const commentLines = pdf.splitTextToSize('Comment: ' + failure.comment, 170);
                        
                        // Check if comment will fit on current page
                        if (yPosition + (commentLines.length * 5) > 240) {
                            yPosition = checkNewPage(yPosition);
                        }
                        
                        pdf.text(commentLines, 25, yPosition);
                        yPosition += commentLines.length * 5;
                    }
                    
                    if (failure.imageData) {
                        // Check if image will fit on current page
                        if (yPosition + 70 > 240) {
                            yPosition = checkNewPage(yPosition);
                        }
                        
                        pdf.setFont(undefined, 'italic');
                        pdf.text('Image:', 25, yPosition);
                        yPosition += 8;
                        const imageHeight = addImageToPDF(pdf, failure.imageData, 25, yPosition, 80, 60);
                        yPosition += imageHeight;
                    }
                    
                    yPosition += 5;
                });
            } else {
                pdf.setFont(undefined, 'normal');
                pdf.text('No faults identified during inspection.', 20, yPosition);
                yPosition += 10;
            }
            
            if (generalComments) {
                // Check if comments section will fit
                const commentLines = pdf.splitTextToSize(generalComments, 170);
                if (yPosition + 20 + (commentLines.length * 5) > 250) {
                    yPosition = checkNewPage(yPosition);
                }
                
                yPosition += 10;
                pdf.setFont(undefined, 'bold');
                pdf.text('GENERAL COMMENTS:', 20, yPosition);
                yPosition += 10;
                
                pdf.setFont(undefined, 'normal');
                pdf.text(commentLines, 20, yPosition);
                yPosition += commentLines.length * 5 + 10;
            }
            
            // START STRUCTURE AND SYSTEM DETAILS SECTION
            pdf.addPage();
            yPosition = 20;
            
            if (uploadedImages['headerLogoPreview_data']) {
                addImageToPDF(pdf, uploadedImages['headerLogoPreview_data'], 170, 10, 30, 15);
            }
            
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text('STRUCTURE AND SYSTEM DETAILS', 105, yPosition, { align: 'center' });
            yPosition += 20;
            
            // Two column layout
            const leftColumn = 20;
            const rightColumn = 110;
            const columnWidth = 80;
            
            // Left Column - Structure Details
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('STRUCTURE DETAILS', leftColumn, yPosition);
            let leftY = yPosition + 10;
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            
            // Structure measurements
            if (structureHeight) {
                pdf.setFont(undefined, 'bold');
                pdf.text('Structure Height:', leftColumn, leftY);
                pdf.setFont(undefined, 'normal');
                pdf.text(structureHeight + ' m', leftColumn, leftY + 5);
                leftY += 12;
            }
            
            if (structurePerimeter) {
                pdf.setFont(undefined, 'bold');
                pdf.text('Structure Perimeter:', leftColumn, leftY);
                pdf.setFont(undefined, 'normal');
                pdf.text(structurePerimeter + ' m', leftColumn, leftY + 5);
                leftY += 12;
            }
            
            // Structure questions
            const structureQuestions = [
                { key: 'groundType', label: 'Ground Type' },
                { key: 'wallType', label: 'Structure Wall Type' },
                { key: 'roofType', label: 'Roof Type' },
                { key: 'roofStructure', label: 'Roof Structure' }
            ];
            
            structureQuestions.forEach(question => {
                if (systemDetails[question.key] && systemDetails[question.key].length > 0) {
                    pdf.setFont(undefined, 'bold');
                    pdf.text(question.label + ':', leftColumn, leftY);
                    leftY += 5;
                    pdf.setFont(undefined, 'normal');
                    
                    const answers = systemDetails[question.key].join(', ');
                    const answerLines = pdf.splitTextToSize(answers, columnWidth);
                    pdf.text(answerLines, leftColumn, leftY);
                    leftY += answerLines.length * 4 + 8;
                }
            });
            
            // Right Column - System Details
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('SYSTEM DETAILS', rightColumn, yPosition);
            let rightY = yPosition + 10;
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            
            // System questions
            const systemQuestions = [
                { key: 'airTermination', label: 'Air-Termination Type' },
                { key: 'atConductors', label: 'AT Conductors' },
                { key: 'downConductorType', label: 'Down Conductor Type' },
                { key: 'dcConductors', label: 'DC Conductors' }
            ];
            
            systemQuestions.forEach(question => {
                if (systemDetails[question.key] && systemDetails[question.key].length > 0) {
                    pdf.setFont(undefined, 'bold');
                    pdf.text(question.label + ':', rightColumn, rightY);
                    rightY += 5;
                    pdf.setFont(undefined, 'normal');
                    
                    const answers = systemDetails[question.key].join(', ');
                    const answerLines = pdf.splitTextToSize(answers, columnWidth);
                    pdf.text(answerLines, rightColumn, rightY);
                    rightY += answerLines.length * 4 + 8;
                }
            });
            
            // Dropdown questions
            if (earthPits) {
                pdf.setFont(undefined, 'bold');
                pdf.text('Earth Pits:', rightColumn, rightY);
                pdf.setFont(undefined, 'normal');
                pdf.text(earthPits, rightColumn, rightY + 5);
                rightY += 12;
            }
            
            if (mainEquipotentialBond) {
                pdf.setFont(undefined, 'bold');
                pdf.text('Main Equipotential Bond:', rightColumn, rightY);
                pdf.setFont(undefined, 'normal');
                pdf.text(mainEquipotentialBond, rightColumn, rightY + 5);
                rightY += 12;
            }
            
            // Surge Protection
            if (surgeInstalled) {
                pdf.setFont(undefined, 'bold');
                pdf.text('Surge Protection Installed:', rightColumn, rightY);
                pdf.setFont(undefined, 'normal');
                pdf.text(surgeInstalled, rightColumn, rightY + 5);
                rightY += 12;
                
                if (surgeInstalled === 'Yes' && surgeType) {
                    pdf.setFont(undefined, 'bold');
                    pdf.text('Surge Protection Type:', rightColumn, rightY);
                    pdf.setFont(undefined, 'normal');
                    pdf.text(surgeType, rightColumn, rightY + 5);
                    rightY += 12;
                }
                
                if (surgeInstalled === 'Yes' && surgeSafe) {
                    pdf.setFont(undefined, 'bold');
                    pdf.text('Surge Protection Status:', rightColumn, rightY);
                    pdf.setFont(undefined, 'normal');
                    pdf.text(surgeSafe, rightColumn, rightY + 5);
                    rightY += 12;
                }
            }
            
            // Check if either column needs a new page
            const maxY = Math.max(leftY, rightY);
            if (maxY > 250) {
                pdf.addPage();
                yPosition = 20;
                
                if (uploadedImages['headerLogoPreview_data']) {
                    addImageToPDF(pdf, uploadedImages['headerLogoPreview_data'], 170, 10, 30, 15);
                }
                
                // Continue with any remaining content
            }
            
            // START EARTH RESISTANCE TESTING SECTION
            pdf.addPage();
            yPosition = 20;
            
            if (uploadedImages['headerLogoPreview_data']) {
                addImageToPDF(pdf, uploadedImages['headerLogoPreview_data'], 170, 10, 30, 15);
            }
            
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text('EARTH RESISTANCE TESTING', 20, yPosition);
            yPosition += 15;
            
            const numEarths = parseInt(document.getElementById('numEarths').value) || 0;
            if (numEarths > 0) {
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text('Individual Earth Readings:', 20, yPosition);
                yPosition += 10;
                
                pdf.setFont(undefined, 'normal');
                earthResistances.forEach((resistance, index) => {
                    yPosition = checkNewPage(yPosition, 270);
                    pdf.text('Earth ' + (index + 1) + ': ' + resistance.toFixed(2) + ' Ohm', 20, yPosition);
                    yPosition += 8;
                });
                
                if (earthResistances.some(r => r > 0)) {
                    const validResistances = earthResistances.filter(r => r > 0);
                    const reciprocalSum = validResistances.reduce((sum, r) => sum + (1/r), 0);
                    const overallResistance = 1 / reciprocalSum;
                    
                    yPosition += 10;
                    pdf.setFont(undefined, 'bold');
                    pdf.text('Overall System Resistance: ' + overallResistance.toFixed(3) + ' Ohm', 20, yPosition);
                    yPosition += 10;
                    
                    pdf.setFont(undefined, 'normal');
                    if (overallResistance <= 10) {
                        pdf.setTextColor(34, 139, 34);
                        pdf.text('✓ Complies with 10 Ohm requirement', 20, yPosition);
                    } else {
                        pdf.setTextColor(220, 20, 60);
                        pdf.text('✗ Exceeds 10 Ohm requirement - FAIL', 20, yPosition);
                    }
                    pdf.setTextColor(0, 0, 0);
                    yPosition += 15;
                }
                
                // Earth test images in two columns
                if (uploadedImages['earthImagesPreview_data']) {
                    pdf.setFont(undefined, 'bold');
                    pdf.text('Earth Test Images:', 20, yPosition);
                    yPosition += 10;
                    
                    const images = Array.isArray(uploadedImages['earthImagesPreview_data']) ? 
                        uploadedImages['earthImagesPreview_data'] : [uploadedImages['earthImagesPreview_data']];
                    
                    let leftColumnY = yPosition;
                    let rightColumnY = yPosition;
                    const leftColumnX = 20;
                    const rightColumnX = 110;
                    
                    images.forEach((imageData, index) => {
                        if (imageData) {
                            const isLeftColumn = index % 2 === 0;
                            const xPos = isLeftColumn ? leftColumnX : rightColumnX;
                            let currentY = isLeftColumn ? leftColumnY : rightColumnY;
                            
                            // Check if we need a new page
                            if (currentY > 200) {
                                pdf.addPage();
                                leftColumnY = 30;
                                rightColumnY = 30;
                                if (uploadedImages['headerLogoPreview_data']) {
                                    addImageToPDF(pdf, uploadedImages['headerLogoPreview_data'], 170, 10, 30, 15);
                                }
                                currentY = isLeftColumn ? leftColumnY : rightColumnY;
                            }
                            
                            const imageHeight = addImageToPDF(pdf, imageData, xPos, currentY, 80, 60);
                            currentY += imageHeight + 5;
                            
                            if (isLeftColumn) {
                                leftColumnY = currentY;
                            } else {
                                rightColumnY = currentY;
                            }
                        }
                    });
                    
                    yPosition = Math.max(leftColumnY, rightColumnY) + 10;
                }
            } else {
                pdf.setFont(undefined, 'normal');
                pdf.text('No earth resistance testing performed.', 20, yPosition);
                yPosition += 15;
            }
            
            if (finalComments) {
                // Check if final comments will fit
                const finalLines = pdf.splitTextToSize(finalComments, 170);
                if (yPosition + 20 + (finalLines.length * 5) > 250) {
                    pdf.addPage();
                    yPosition = 20;
                    if (uploadedImages['headerLogoPreview_data']) {
                        addImageToPDF(pdf, uploadedImages['headerLogoPreview_data'], 170, 10, 30, 15);
                        yPosition = 30;
                    }
                }
                
                yPosition += 10;
                pdf.setFont(undefined, 'bold');
                pdf.text('FINAL SUMMARY & RECOMMENDATIONS:', 20, yPosition);
                yPosition += 10;
                
                pdf.setFont(undefined, 'normal');
                pdf.text(finalLines, 20, yPosition);
            }
            
            // Add footer to all pages except cover page
            const totalPages = pdf.internal.getNumberOfPages();
            for (let i = 2; i <= totalPages; i++) {
                pdf.setPage(i);
                pdf.setFontSize(8);
                const footerLines = pdf.splitTextToSize(footer, 190);
                pdf.text(footerLines, 105, 280, { align: 'center' });
            }
            
            // Generate filename
            const date = new Date().toISOString().split('T')[0];
            const filename = 'Lightning_Protection_Report_' + date + '.pdf';
            
            // Save the PDF
            pdf.save(filename);
        }
    </script>
</body>
</html>
    </script>
</body>
</html>
